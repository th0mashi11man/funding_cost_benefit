<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Research Funding Financial Cost-Benefit Calculator</title>
<style>
  :root{
    --bg:#0b1020; --panel:#11192f; --muted:#9fb0c7; --text:#e6eef7;
    --accent:#7bbfff; --ok:#5bd69f; --warn:#ffd166; --bad:#ff6b6b;
    --gold:#f1c232; --green:#93c47d; --blue:#6fa8dc; --red:#e06666; --purple:#b37bd6;
    --border:rgba(255,255,255,0.14); --panel2:#0d1431;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1020;color:var(--text)}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 14px;font-size:clamp(1.1rem,2.2vw,1.6rem)}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
  .grid{display:grid;gap:14px}
  @media (min-width:820px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  label{display:block;font-weight:600;margin:6px 0}
  input,select{width:100%;background:#0b1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:1rem}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
  .help{font-size:.9rem;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-variant-numeric:tabular-nums}
  button{background:var(--accent);color:#071225;font-weight:700;border:none;border-radius:999px;padding:9px 18px;font-size:.95rem;cursor:pointer}
  button.secondary{background:transparent;color:var(--muted);border:1px solid var(--border)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;background:var(--panel2);padding:4px 10px;font-size:.9rem;border:1px solid var(--border)}
  .pill.error{background:rgba(255,107,107,0.08);border-color:rgba(255,107,107,0.6);color:#ffe3e3}
  .hidden{display:none !important}
  .tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:.85rem;font-weight:600;letter-spacing:.03em;text-transform:uppercase}
  .tag.ok{background:rgba(91,214,159,0.1);color:var(--ok);border:1px solid rgba(91,214,159,0.6)}
  .tag.warn{background:rgba(255,209,102,0.08);color:var(--warn);border:1px solid rgba(255,209,102,0.7)}
  .tag.bad{background:rgba(255,107,107,0.08);color:var(--bad);border:1px solid rgba(255,107,107,0.7)}
  .bar-wrap{margin-top:14px}
  .bar{display:flex;height:26px;border-radius:999px;overflow:hidden;border:1px solid var(--border);background:#050814;font-size:.8rem}
  .bar span{display:flex;align-items:center;justify-content:center;padding:0 4px}
  .bar .over{background:rgba(123,191,255,0.35)}
  .bar .other{background:rgba(241,194,50,0.4)}
  .bar .salary{background:rgba(147,196,125,0.6)}
  .bar .fac{background:rgba(179,123,214,0.55)}
  .bar .cofin{background:rgba(224,102,102,0.7)}
  .legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;font-size:.8rem;color:var(--muted)}
  .legend .pill{background:transparent}
  .legend-key{width:10px;height:10px;border-radius:4px;margin-right:4px}
  .l-over{background:rgba(123,191,255,0.9)}
  .l-other{background:rgba(241,194,50,0.9)}
  .l-salary{background:rgba(147,196,125,0.9)}
  .l-fac{background:rgba(179,123,214,0.9)}
  .l-cofin{background:rgba(224,102,102,0.9)}
  .result{margin-top:14px}
  .details-grid{display:grid;gap:10px;margin-top:10px}
  @media (min-width:820px){.details-grid.cols-2{grid-template-columns:1fr 1fr}}
  .kv{display:grid;grid-template-columns:auto 1fr;column-gap:10px;row-gap:4px;font-size:.9rem}
  .kv .k{color:var(--muted)}
  .kv .v{text-align:right}
  .section-title{font-size:.85rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin:6px 0}
  .footer{margin:18px 0 8px;font-size:.8rem;color:var(--muted)}
  a{color:var(--accent)}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="pageTitle">Applied IT – Research Funding Financial Cost-Benefit Calculator</h1>

  <!-- Top bar with OH policy and config status -->
  <div class="section">
    <div class="row" style="justify-content:space-between;align-items:center;gap:10px">
      <div>
        <strong>Overhead policy</strong>
        <span id="ohBadge" class="pill hidden"></span>
      </div>
      <div id="configWarn" class="pill error hidden" style="margin-left:auto">
        Could not load <span class="mono">config.json</span>. Using fallback.
      </div>
    </div>
  </div>

  <!-- STEP 1: select scheme -->
  <div class="section" id="schemeSection">
    <label for="schemeSelect">1. Select grant scheme</label>
    <select id="schemeSelect"></select>
    <div class="help" id="schemeInfo" style="margin-top:6px">
      Start by choosing the grant scheme. If it isn't listed, choose Other.
    </div>
  </div>

  <!-- STEP 2: project & funder inputs (shown after scheme is chosen) -->
  <div class="section hidden" id="projectSection">
    <strong>2. Project parameters & funder coverage</strong>
    <div class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="requestedAmount">Amount for Applied IT (excl. funding for partners)</label>
        <input id="requestedAmount" data-decimal="false" inputmode="numeric" placeholder="e.g., 10 000 000"/>
      </div>
      <div>
        <label for="projectYears">Project duration (years)</label>
        <input id="projectYears" data-decimal="false" inputmode="numeric" placeholder="e.g., 4"/>
      </div>
      <div id="staffFTERow" class="hidden">
        <label for="staffFTE">Number of positions funded (FTE)</label>
        <input id="staffFTE" data-decimal="true" placeholder="e.g., 1.5"/>
        <div class="help">Used for RJ schemes where the foundation contributes 170 000 SEK per FTE and year on top of the grant.</div>
      </div>
      <div>
        <label>Available for direct costs (live)</label>
        <div class="pill mono" id="availableDirectLine">—</div>
      </div>
    </div>

    <!-- Manual funder controls (only for "Other") -->
    <div id="funderControls" class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="funderModeSelect">Funder indirect cost coverage</label>
        <select id="funderModeSelect">
          <option value="percent_overhead" selected>% of overhead</option>
          <option value="absolute">Fixed amount</option>
          <option value="percent_total">% of total</option>
        </select>
      </div>
      <div>
        <div id="funderPercentOverBox">
          <label for="funderPercentOverhead">% of overhead covered</label>
          <input id="funderPercentOverhead" data-decimal="true" placeholder="e.g., 75"/>
        </div>
        <div id="funderAbsoluteBox" class="hidden">
          <label for="funderOverheadAbsolute">Fixed amount for indirect costs</label>
          <input id="funderOverheadAbsolute" data-decimal="false" inputmode="numeric" placeholder="e.g., 1 000 000"/>
        </div>
        <div id="funderPercentTotalBox" class="hidden">
          <label for="funderOverheadPercent">% of total grant for indirect costs</label>
          <input id="funderOverheadPercent" data-decimal="true" placeholder="e.g., 20"/>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 3: Direct costs (shown after scheme is chosen) -->
  <div class="section hidden" id="directSection">
    <strong>3. Direct cost allocation</strong>
    <div class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="plannedSalaryDirect">Planned salary costs</label>
        <input id="plannedSalaryDirect" data-decimal="false" inputmode="numeric" placeholder="e.g., 7 000 000"/>
      </div>
      <div>
        <label for="existingSalaries">…of which salary for existing staff</label>
        <input id="existingSalaries" data-decimal="false" inputmode="numeric" placeholder="e.g., 6 000 000"/>
      </div>
      <div id="serviceRow" class="hidden">
        <label for="servicePurchases">Service purchases (consultants, subcontracting, evaluation)</label>
        <input id="servicePurchases" data-decimal="false" inputmode="numeric" placeholder="e.g., 500 000"/>
        <div class="help">
          For EU–Horizon, this amount is part of the Applied IT budget. The department must co-finance 100% of the overhead on these costs.
        </div>
      </div>
      <div>
        <label>Available for other direct costs (live)</label>
        <div class="pill mono" id="availableOtherLine">—</div>
      </div>
    </div>
  </div>

  <!-- STEP 4: Calculation and results (shown after scheme is chosen) -->
  <div class="section hidden" id="calcSection">
    <div class="row" style="justify-content:flex-end;gap:10px">
      <button id="calcBtn">Calculate</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div class="result hidden" id="resultContainer">
      <div id="resultTag" class="tag warn">Result pending…</div>
      <p id="resultExplanation" class="help" style="margin:8px 0 0"></p>

      <div class="bar-wrap">
        <div class="bar hidden" id="barContainer">
          <span class="over" id="overheadBar"></span>
          <span class="other" id="otherBar"></span>
          <span class="salary" id="salaryBar"></span>
          <span class="fac" id="facBar"></span>
          <span class="cofin" id="cofinBar"></span>
        </div>
        <div class="legend hidden" id="legend">
          <span class="pill" id="leg-over"><span class="legend-key l-over"></span>Overhead covered by funder</span>
          <span class="pill" id="leg-other"><span class="legend-key l-other"></span>Other direct costs</span>
          <span class="pill" id="leg-salary"><span class="legend-key l-salary"></span>Existing staff salaries covered</span>
          <span class="pill" id="leg-fac"><span class="legend-key l-fac"></span>Univ/Faculty contribution</span>
          <span class="pill" id="leg-cofin"><span class="legend-key l-cofin"></span>Departmental co-financing</span>
        </div>
      </div>

      <div class="section" id="summaryBox" style="margin-top:14px;display:none">
        <div id="numbersDump"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>NB: This tool is for illustrative purposes only. Always verify with a financial officer before submitting applications.</div>
  </div>
</div>

<script>
  // ---------- helpers
  const $ = id => document.getElementById(id);
  const fmt = n => (isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:0}).replace(/,/g,' ') : '—');

  const RJ_TOPUP_PER_FTE_YEAR = 170000;

  // Parse numbers that may include spaces, comma/dot decimals
  function num(s){
    if(!s) return 0;
    const t=String(s);
    let u=t.replace(/[^\d.,\s-]/g,'').trim();
    const neg = /^-/.test(u);
    u=u.replace(/-/g,'');
    const lastComma=u.lastIndexOf(','), lastDot=u.lastIndexOf('.');
    let decSep=null;
    if(lastComma>lastDot) decSep=',';
    else if(lastDot>lastComma) decSep='.';
    if(decSep){
      const i=u.lastIndexOf(decSep);
      const ip=u.slice(0,i).replace(/[^\d]/g,'');
      const dp=u.slice(i+1).replace(/[^\d]/g,'');
      return (neg?-1:1)*Number(ip+'.'+dp || '0');
    } else {
      return (neg?-1:1)*Number(u.replace(/[^\d]/g,'') || '0');
    }
  }

  function formatNumericInput(el){
    const allowDecimal = el.getAttribute('data-decimal') === 'true';
    const original = el.value;
    let v = original.replace(/[^\d.,]/g,'');
    const lastComma=v.lastIndexOf(','), lastDot=v.lastIndexOf('.');
    let decSep=null;
    if(allowDecimal && (lastComma>=0 || lastDot>=0)) decSep = (lastComma>lastDot)?',':'.';
    if(decSep){
      v = v.replace(decSep==='.'?/,/g:/\./g,'');
    } else {
      v = v.replace(/[.,]/g,'');
    }
    let intPart=v, fracPart='';
    if(decSep){
      const ix=v.indexOf(decSep);
      if(ix>=0){
        intPart=v.slice(0,ix);
        fracPart=v.slice(ix+1).replace(/[^\d]/g,'');
      }
    }
    intPart=intPart.replace(/[^\d]/g,'');
    const formattedInt=intPart.replace(/\B(?=(\d{3})+(?!\d))/g,' ');

    // *** FIX: always keep the decimal separator if decimals are allowed and one was typed,
    // even if there are not yet any decimal digits after it.
    el.value = formattedInt + ((allowDecimal && decSep) ? (decSep + fracPart) : '');
  }

  function attachFormatters(){
    document.querySelectorAll('input[data-decimal]').forEach(el=>{
      el.addEventListener('input', ()=>{ formatNumericInput(el); updateLive(); });
      el.addEventListener('blur', ()=>{ formatNumericInput(el); updateLive(); });
    });
  }

  const clamp = (x,min,max)=>Math.max(min,Math.min(x,max));

  // ---------- elements
  const ohBadge=$('ohBadge'), configWarn=$('configWarn');

  const projectSection = $('projectSection');
  const directSection = $('directSection');
  const calcSection = $('calcSection');

  const schemeSelect=$('schemeSelect'), schemeInfo=$('schemeInfo');

  const requestedAmount=$('requestedAmount'), projectYears=$('projectYears');
  const staffFTERow=$('staffFTERow'), staffFTE=$('staffFTE');

  const funderControls=$('funderControls');
  const funderModeSelect=$('funderModeSelect');
  const funderPercentOverBox=$('funderPercentOverBox');
  const funderAbsoluteBox=$('funderAbsoluteBox');
  const funderPercentTotalBox=$('funderPercentTotalBox');

  const funderPercentOverhead=$('funderPercentOverhead');
  const funderOverheadAbsolute=$('funderOverheadAbsolute');
  const funderOverheadPercent=$('funderOverheadPercent');

  const availableDirectLine=$('availableDirectLine');
  const availableOtherLine=$('availableOtherLine');
  const plannedSalaryDirect=$('plannedSalaryDirect'), existingSalaries=$('existingSalaries');

  const serviceRow=$('serviceRow'), servicePurchases=$('servicePurchases');

  const resultContainer=$('resultContainer'), resultTag=$('resultTag'), resultExplanation=$('resultExplanation');
  const barContainer=$('barContainer'), legend=$('legend');
  const bars={overhead:$('overheadBar'), other:$('otherBar'), salary:$('salaryBar'), fac:$('facBar'), cofin:$('cofinBar')};
  const numbersDump=$('numbersDump'), summaryBox=$('summaryBox');

  // ---------- state
  let CONFIG=null, SCHEMES={};
  let salaryOH=0.62, otherOH=0.52;
  let activeScheme=null;
  let lastShare=0.5;

  const schemesNeedingFTE = new Set(['rj_programme','rj_project']);
  const schemesNeedingService = new Set(['horizon']);

  // ---------- UF rules engine
  function computeUfAmount(rule, total, years, deptOver, coFinRaw){
    const yrs = Math.max(1, Math.round(num(years)));
    if(!rule || !rule.mode) return 0;
    const mode = rule.mode;

    if(mode === 'fixed'){
      const a = Number(rule.amount || 0);
      return Math.max(0, Math.round(a));
    }

    if(mode === 'fixed_per_year'){
      const a = Number(rule.amount_per_year || 0);
      return Math.max(0, Math.round(a * yrs));
    }

    if(mode === 'percent_total'){
      const p = Number(rule.value || 0) / 100;
      return Math.max(0, Math.round(total * p));
    }

    if(mode === 'percent_overhead'){
      const p = Number(rule.value || 0) / 100;
      return Math.max(0, Math.round(deptOver * p));
    }

    if(mode === 'percent_total_capped_per_year'){
      const p = Number(rule.value || 0) / 100;
      const cap = Number(rule.per_year_cap || 0);
      const raw = total * p;
      const capped = Math.min(raw, cap * yrs);
      return Math.max(0, Math.round(capped));
    }

    // per_fte_per_year is handled as project top-up, not OH coverage
    if(mode === 'per_fte_per_year'){
      return 0;
    }

    if(mode === 'oh_gap_share'){
      const share = Number(rule.value || 0) / 100;
      const base = Math.max(0, Number(coFinRaw || 0));
      return Math.max(0, Math.round(base * share));
    }

    return 0;
  }

  function sumUfAmount(rules, total, years, deptOver, coFinRaw){
    if(!Array.isArray(rules) || rules.length===0) return {amount:0, note:'', byName:{}};
    let sum=0;
    const byName = {};
    for(const r of rules){
      if(r.mode === 'per_fte_per_year') continue;
      const a = computeUfAmount(r, total, years, deptOver, coFinRaw);
      sum += a;
      if(r.name){
        byName[r.name] = (byName[r.name] || 0) + a;
      }
    }
    return {amount: sum, note:'', byName};
  }

  // ---------- salary clamping
  function clampSalaryInputs(direct){
    let planned = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    if(planned > direct){ planned = direct; plannedSalaryDirect.value = fmt(planned); }
    let existing = Math.max(0, Math.round(num(existingSalaries.value)));
    if(existing > planned){ existing = planned; existingSalaries.value = fmt(existing); }
  }

  // ---------- core math
  function getFunderCoverage(total, deptOver){
    if(!activeScheme || !activeScheme.funder) return 0;
    const mode = activeScheme.funder.mode;
    if(mode==='percent_overhead'){
      const p = (activeScheme.funder.value != null ? activeScheme.funder.value : num(funderPercentOverhead.value));
      return Math.round(deptOver * Math.max(0, Math.min(p,100)) / 100);
    }
    if(mode==='percent_total'){
      const p = (activeScheme.funder.value != null ? activeScheme.funder.value : num(funderOverheadPercent.value));
      const dec = Math.max(0, Math.min(p,500))/100;
      return Math.round(total * (dec/(1+dec)));
    }
    if(mode==='absolute'){
      const a = (activeScheme.funder.value != null ? activeScheme.funder.value : num(funderOverheadAbsolute.value));
      return Math.max(0, Math.min(Math.round(a), total));
    }
    if(mode==='manual'){
      const m = funderModeSelect.value;
      if(m==='percent_overhead'){
        const p = num(funderPercentOverhead.value);
        return Math.round(deptOver * Math.max(0, Math.min(p,100)) / 100);
      }
      if(m==='absolute'){
        const a = num(funderOverheadAbsolute.value);
        return Math.max(0, Math.min(Math.round(a), total));
      }
      if(m==='percent_total'){
        const p = num(funderOverheadPercent.value);
        const dec = Math.max(0, Math.min(p,500))/100;
        return Math.round(total * (dec/(1+dec)));
      }
    }
    return 0;
  }

  function calcWithDerivedShare(total){
    if(!activeScheme){
      return {deptOver:0, direct:0};
    }
    let share = lastShare;
    const rs = Math.max(0, Math.min(salaryOH,5));
    const ro = Math.max(0, Math.min(otherOH,5));
    let deptOver=0, fundCov=0, used=0, direct=0;
    for(let i=0;i<3;i++){
      const rEff = rs*share + ro*(1-share);
      deptOver = Math.round(total * (rEff/(1+rEff)));
      fundCov  = getFunderCoverage(total, deptOver);
      used     = Math.min(deptOver, fundCov);
      direct   = Math.max(0, total - used);
      const ps = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
      share    = direct>0 ? Math.max(0, Math.min(ps/direct, 1)) : 0;
    }
    lastShare = share;
    return {deptOver, direct};
  }

  // RJ top-up: base, bonus, total
  function getEffectiveTotal(){
    const base = Math.round(num(requestedAmount.value));
    let bonus = 0;
    if(activeScheme && schemesNeedingFTE.has(activeScheme.id)){
      const fte = Math.max(0, Number(num(staffFTE.value)));
      const yrs = Math.max(1, Math.round(num(projectYears.value || '1')));
      bonus = Math.max(0, Math.round(RJ_TOPUP_PER_FTE_YEAR * fte * yrs));
    }
    return { base, bonus, total: base + bonus };
  }

  // ---------- UI logic
  function toggleFunderInputs(){
    const isOther = (activeScheme && activeScheme.id==='other');
    funderControls.classList.toggle('hidden', !isOther);
    const mode = isOther ? funderModeSelect.value : 'percent_overhead';
    funderPercentOverBox.classList.toggle('hidden', !(isOther && mode==='percent_overhead'));
    funderAbsoluteBox.classList.toggle('hidden', !(isOther && mode==='absolute'));
    funderPercentTotalBox.classList.toggle('hidden', !(isOther && mode==='percent_total'));
  }

  function showCoreSections(show){
    projectSection.classList.toggle('hidden', !show);
    directSection.classList.toggle('hidden', !show);
    calcSection.classList.toggle('hidden', !show);
  }

  function describeScheme(sc){
    if(!sc){
      return 'Start by choosing the grant scheme. If it isn\'t listed, choose Other.';
    }

    const parts = [];

    // 1) Funder explanation (config-driven)
    if(sc.funder && sc.funder.label){
      parts.push(`<strong>Funder:</strong> ${sc.funder.label}.`);
    }

    // 2) University / Faculty / other internal contributions from uf_rules
    if (Array.isArray(sc.uf_rules) && sc.uf_rules.length) {
      const uniLines = [];
      const facLines = [];
      const otherLines = [];

      sc.uf_rules.forEach(r => {
        if (r.mode === 'per_fte_per_year') return; // RJ top-up handled separately

        const name = (r.name || '').toLowerCase();
        const note = r.notes || '';

        // University-level: allow "Rektor", "University", "VC", "Vice Chancellor", etc.
        if (/rektor|university|vice|vc/.test(name)) {
          uniLines.push(note || 'Contributes to covering part of the overhead costs.');
        }
        // Faculty-level
        else if (/faculty/.test(name)) {
          facLines.push(note || 'Contributes to covering part of the overhead costs.');
        }
        // Other internal mechanisms if you ever use them
        else if (note) {
          otherLines.push(`${r.name ? r.name + ': ' : ''}${note}`);
        }
      });

      if (uniLines.length) {
        parts.push(`<strong>University co-funding:</strong> ${uniLines.join(' ')}`);
      }
      if (facLines.length) {
        parts.push(`<strong>Faculty co-funding:</strong> ${facLines.join(' ')}`);
      }
      if (otherLines.length) {
        parts.push(`<strong>Other internal co-funding:</strong> ${otherLines.join(' ')}`);
      }
    }

    // 3) Structural scheme-specific clarifications
    if(sc.id === 'horizon'){
      parts.push('<strong>Special rule:</strong> All indirect costs on service purchases must be covered by the department.');
    }
    if(sc.id === 'rj_programme' || sc.id === 'rj_project'){
      parts.push('<strong>Special rule:</strong> The 170 000 SEK per FTE and year is added on top of the RJ grant amount and does not reduce the requested amount from RJ.');
    }

    return parts.join('<br>');
  }

  function updateLive(){
    if(!activeScheme){
      availableDirectLine.textContent='—';
      availableOtherLine.textContent='—';
      return;
    }
    const { total } = getEffectiveTotal();
    const {deptOver, direct} = calcWithDerivedShare(total);
    availableDirectLine.textContent = fmt(direct);
    const plannedSal = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    const other = Math.max(0, direct - plannedSal);
    availableOtherLine.textContent = fmt(other);
  }

  function applyScheme(){
    const val = schemeSelect.value;
    if(!val){
      activeScheme = null;
      schemeInfo.innerHTML = describeScheme(null);
      showCoreSections(false);
      updateLive();
      return;
    }
    activeScheme = SCHEMES[val] || null;

    showCoreSections(true);

    const id = activeScheme.id;
    staffFTERow.classList.toggle('hidden', !schemesNeedingFTE.has(id));
    serviceRow.classList.toggle('hidden', !schemesNeedingService.has(id));

    toggleFunderInputs();
    schemeInfo.innerHTML = describeScheme(activeScheme);
    updateLive();
  }

  function renderSummary(d){
    const row=(l,v)=> (v>0 || v===0) ? `<div class="k">${l}</div><div class="v mono">${fmt(v)}</div>` : '';
    const text=(l,v)=>`<div class="k">${l}</div><div class="v">${v}</div>`;

    // Group UF contributions dynamically by name pattern
    let uniAmount = 0;
    let facAmount = 0;
    let otherUF   = 0;

    if (d.ufByName) {
      for (const [name, val] of Object.entries(d.ufByName)) {
        const n = (name || '').toLowerCase();
        if (/rektor|university|vice|vc/.test(n)) {
          uniAmount += val;
        } else if (/faculty/.test(n)) {
          facAmount += val;
        } else {
          otherUF += val;
        }
      }
    }

    const isRJ = (d.schemeId === 'rj_programme' || d.schemeId === 'rj_project');

    return `
    <div class="details-grid cols-2">
      <div>
        <div class="section-title">Inputs</div>
        <div class="kv">
          ${text('Grant scheme', d.scheme)}
          ${row('Amount for Applied IT (entered)', d.baseTotal)}
          ${isRJ && d.rjTopup>0 ? row('RJ top-up (170k/FTE/year, added)', d.rjTopup) : ''}
          ${row('Total project volume used in calculation', d.effectiveTotal)}
          ${text('Project duration', d.years + ' year(s)')}
        </div>

        <div class="section-title">Indirect costs & coverage</div>
        <div class="kv">
          ${row('Department overhead (cascading)', d.deptOver)}
          ${row('Funder indirect coverage', d.funderCoverage)}
          ${d.ufApplied>0 ? row('Univ/Faculty contribution (total)', d.ufApplied) : ''}
          ${uniAmount ? row('…of which University', uniAmount) : ''}
          ${facAmount ? row('…of which Faculty', facAmount) : ''}
          ${otherUF ? row('…other UF contributions', otherUF) : ''}
        </div>
      </div>

      <div>
        <div class="section-title">Direct costs</div>
        <div class="kv">
          ${row('Direct funds available', d.direct)}
          ${row('Planned salary costs', d.plannedSal)}
          ${row('…of which existing staff salaries', d.userSalaries)}
          ${row('Other direct costs (non-service)', d.other)}
          ${row('Service purchases (dept-funded OH only)', d.deptService)}
        </div>

        <div class="section-title">Departmental co-financing needed</div>
        <div class="kv">
          ${row('Dept co-financing for OH gap', d.coFinNetOH)}
          ${row('Dept co-financing for service purchases (OH)', d.deptService)}
          ${row('Total departmental co-financing', d.coFinNetTotal)}
        </div>
      </div>
    </div>`;
  }

  // ---------- Calculate & render
  function calculate(){
    if(!activeScheme){
      alert('Please select a grant scheme first.');
      return;
    }
    const years = projectYears.value || '1';
    const { base, bonus: rjTopup, total: effectiveTotal } = getEffectiveTotal();
    const {deptOver, direct} = calcWithDerivedShare(effectiveTotal);

    const service = Math.max(0, Math.round(num(servicePurchases.value || 0)));

    let funderCoverage = 0;
    let coFinRaw = 0;
    let ufAgg, ufApplied, ufByNameScaled, coFinNetOH;
    let deptService = 0;

    if (activeScheme && activeScheme.id === 'horizon') {
      // Overhead on service purchases: department must cover 100% of this OH
      const serviceOH = Math.round(service * (otherOH / (1 + otherOH)));
      deptService = serviceOH;

      const nonServiceOver = Math.max(0, deptOver - serviceOH);

      // EU covers configured share of OH on non-service costs
      funderCoverage = getFunderCoverage(effectiveTotal, nonServiceOver);

      const coveredNonService = Math.min(nonServiceOver, funderCoverage);
      coFinRaw = Math.max(0, nonServiceOver - coveredNonService);

      ufAgg = sumUfAmount(activeScheme.uf_rules, base, years, nonServiceOver, coFinRaw);
      ufApplied = Math.min(ufAgg.amount, coFinRaw);

      const scale = ufAgg.amount > 0 ? (ufApplied / ufAgg.amount) : 0;
      ufByNameScaled = {};
      for (const [name, val] of Object.entries(ufAgg.byName || {})) {
        ufByNameScaled[name] = Math.round(val * scale);
      }

      // OH gap after UF on non-service costs
      coFinNetOH = Math.max(0, coFinRaw - ufApplied);

      // For bar visualisation, funderCoverage is coverage on non-service OH only
      funderCoverage = coveredNonService;
    } else {
      funderCoverage = getFunderCoverage(effectiveTotal, deptOver);

      const covered = Math.min(deptOver, funderCoverage);
      coFinRaw = Math.max(0, deptOver - covered);

      ufAgg = sumUfAmount(activeScheme.uf_rules, base, years, deptOver, coFinRaw);
      ufApplied = Math.min(ufAgg.amount, coFinRaw);

      const scale = ufAgg.amount > 0 ? (ufApplied / ufAgg.amount) : 0;
      ufByNameScaled = {};
      for (const [name, val] of Object.entries(ufAgg.byName || {})) {
        ufByNameScaled[name] = Math.round(val * scale);
      }

      coFinNetOH = Math.max(0, coFinRaw - ufApplied);
    }

    clampSalaryInputs(direct);
    const plannedSal = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    const userSalaries = Math.max(0, Math.round(num(existingSalaries.value)));
    const other = Math.max(0, direct - plannedSal);

    const coFinNetTotal = coFinNetOH + deptService;

    // verdict
    let cls='warn', txt='UNCLEAR cost-benefit advantage';
    let expl=`Department co-financing cost after Univ/Faculty contribution (${fmt(coFinNetTotal)}) is comparable to coverage of existing-salary costs (${fmt(userSalaries)}).`;
    if(userSalaries>coFinNetTotal){
      cls='ok'; txt='CLEAR cost-benefit advantage';
      expl=`Coverage of existing-salary costs (${fmt(userSalaries)}) is greater than departmental co-financing cost after Univ/Faculty contribution (${fmt(coFinNetTotal)}).`;
    } else if(userSalaries===coFinNetTotal){
      cls='warn'; txt='BREAK-EVEN';
      expl=`Coverage of existing-salary costs equals departmental co-financing cost after Univ/Faculty contribution (${fmt(coFinNetTotal)}).`;
    }
    resultTag.className='tag '+cls;
    resultTag.textContent=txt;
    resultExplanation.textContent=expl;
    resultContainer.classList.remove('hidden');

    // bar
    const vals = {
      used: Math.min(deptOver, funderCoverage),
      other,
      userSalaries,
      facUsed: ufApplied,
      coFinNet: coFinNetTotal
    };
    const sum = Object.values(vals).reduce((a,b)=>a+b,0);
    if(sum<=0){
      barContainer.classList.add('hidden');
      legend.classList.add('hidden');
    } else {
      barContainer.classList.remove('hidden');
      legend.classList.remove('hidden');
      const frac = x => x>0 ? x/sum : 0;
      function seg(barEl, legId, val){
        const legEl = document.getElementById(legId);
        if(val>0){
          barEl.style.display='flex';
          barEl.style.flex=String(frac(val));
          barEl.textContent=fmt(val);
          legEl.style.display='inline-flex';
        } else {
          barEl.style.display='none';
          barEl.textContent='';
          legEl.style.display='none';
        }
      }
      seg(bars.overhead, 'leg-over',  vals.used);
      seg(bars.other,    'leg-other', vals.other);
      seg(bars.salary,   'leg-salary',vals.userSalaries);
      seg(bars.fac,      'leg-fac',   vals.facUsed);
      seg(bars.cofin,    'leg-cofin', vals.coFinNet);
    }

    // summary
    numbersDump.innerHTML = renderSummary({
      scheme: schemeSelect.options[schemeSelect.selectedIndex].text,
      schemeId: activeScheme.id,
      baseTotal: base,
      rjTopup,
      effectiveTotal,
      years,
      deptOver,
      funderCoverage,
      direct,
      plannedSal,
      userSalaries,
      other,
      coFinNetOH,
      deptService,
      coFinNetTotal,
      ufApplied,
      ufByName: ufByNameScaled
    });
    summaryBox.classList.remove('hidden');
  }

  function showCoreSectionsAndReset(){
    activeScheme = null;
    staffFTERow.classList.add('hidden');
    serviceRow.classList.add('hidden');
    showCoreSections(false);
    schemeInfo.innerHTML = describeScheme(null);
  }

  function resetAll(){
    requestedAmount.value='';
    projectYears.value='';
    staffFTE.value='';
    funderModeSelect.value='percent_overhead';
    funderPercentOverhead.value='';
    funderOverheadAbsolute.value='';
    funderOverheadPercent.value='';
    plannedSalaryDirect.value='';
    existingSalaries.value='';
    servicePurchases.value='';
    availableDirectLine.textContent='—';
    availableOtherLine.textContent='—';
    resultContainer.classList.add('hidden');
    barContainer.classList.add('hidden');
    legend.classList.add('hidden');
    summaryBox.classList.add('hidden');
    numbersDump.innerHTML='';
    lastShare=0.5;

    if(schemeSelect.options.length>0){
      schemeSelect.selectedIndex = 0;
    }
    showCoreSectionsAndReset();
    updateLive();
  }

  // ---------- config load + UI build
  async function loadConfig(){
    const cacheBust = '?v=' + Date.now();
    try{
      const res = await fetch('config.json'+cacheBust, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      CONFIG = await res.json();
      configWarn.classList.add('hidden');

      const oh = CONFIG.overhead || {};
      const lbl = oh.label || '';
      const sal = oh.salary_percent != null ? oh.salary_percent : 0;
      const oth = oh.other_percent  != null ? oh.other_percent  : 0;
      salaryOH = sal/100;
      otherOH = oth/100;
      if(lbl){
        ohBadge.textContent = 'OH ' + lbl + ': salary ' + sal + '%, other ' + oth + '%';
        ohBadge.classList.remove('hidden');
      }
      SCHEMES = {};
      for(const s of (CONFIG.schemes || [])){
        SCHEMES[s.id] = s;
      }

      schemeSelect.innerHTML='';
      const ph=document.createElement('option');
      ph.value=''; ph.textContent='Select grant scheme…'; ph.disabled=true; ph.selected=true;
      schemeSelect.appendChild(ph);
      (CONFIG.schemes || []).forEach(s=>{
        const opt=document.createElement('option');
        opt.value=s.id; opt.textContent=s.name;
        schemeSelect.appendChild(opt);
      });

      showCoreSectionsAndReset();
      updateLive();
    }catch(err){
      console.error('Config load failed', err);
      configWarn.classList.remove('hidden');
      CONFIG = {
        overhead:{label:'fallback',salary_percent:54,other_percent:45},
        schemes:[
          {id:'vr',name:'VR – fallback',funder:{mode:'percent_overhead',value:100,label:'Covers all overhead costs'},uf_rules:[]}
        ]
      };
      salaryOH = CONFIG.overhead.salary_percent/100;
      otherOH = CONFIG.overhead.other_percent/100;
      ohBadge.textContent = 'OH ' + CONFIG.overhead.label + ': salary ' + CONFIG.overhead.salary_percent + '%, other ' + CONFIG.overhead.other_percent + '%';
      ohBadge.classList.remove('hidden');
      SCHEMES = { vr: CONFIG.schemes[0] };
      schemeSelect.innerHTML='';
      const ph=document.createElement('option');
      ph.value=''; ph.textContent='Select grant scheme…'; ph.disabled=true; ph.selected=true;
      schemeSelect.appendChild(ph);
      const opt=document.createElement('option');
      opt.value='vr'; opt.textContent='VR – fallback';
      schemeSelect.appendChild(opt);
      showCoreSectionsAndReset();
    }
  }

  // ---------- events
  function attachLogicListeners(){
    document.querySelectorAll('input[data-decimal]').forEach(el=>{
      el.addEventListener('input', ()=>{ formatNumericInput(el); updateLive(); });
      el.addEventListener('blur', ()=>{ formatNumericInput(el); updateLive(); });
    });

    schemeSelect.addEventListener('change', ()=>{ applyScheme(); });
    funderModeSelect.addEventListener('change', ()=>{ toggleFunderInputs(); updateLive(); });

    ['funderPercentOverhead','funderOverheadAbsolute','funderOverheadPercent'].forEach(id=>{
      const el=$(id);
      el.addEventListener('input', ()=>{ formatNumericInput(el); updateLive(); });
      el.addEventListener('blur', ()=>{ formatNumericInput(el); updateLive(); });
    });

    plannedSalaryDirect.addEventListener('input', updateLive);
    existingSalaries.addEventListener('input', updateLive);

    $('calcBtn').addEventListener('click', calculate);
    $('resetBtn').addEventListener('click', resetAll);
  }

  // ---------- init
  (function init(){
    attachFormatters();
    attachLogicListeners();
    loadConfig();
  })();
</script>
</body>
</html>
