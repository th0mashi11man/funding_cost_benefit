<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Research Funding Financial Cost-Benefit Calculator</title>
<style>
  :root{
    --bg:#0b1020; --panel:#11192f; --muted:#9fb0c7; --text:#e6eef7;
    --accent:#7bbfff; --ok:#5bd69f; --warn:#ffd166; --bad:#ff6b6b;
    --gold:#f1c232; --green:#93c47d; --blue:#6fa8dc; --red:#e06666; --purple:#b37bd6;
    --border:rgba(255,255,255,0.14); --panel2:#0d1431;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1020;color:var(--text)}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 14px;font-size:clamp(1.1rem,2.2vw,1.6rem)}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
  .grid{display:grid;gap:14px}
  @media (min-width:820px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  label{display:block;font-weight:600;margin:6px 0}
  input,select{width:100%;background:#0b1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:1rem}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
  .help{font-size:.9rem;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-variant-numeric:tabular-nums}
  button{background:var(--accent);color:#071225;font-weight:700;border:none;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:1rem}
  button.secondary{background:transparent;color:#9fb0c7;border:1px solid var(--border)}
  .result{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:14px}
  .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700}
  .ok{background:rgba(91,214,159,.12);color:var(--ok);border:1px solid rgba(91,214,159,.25)}
  .warn{background:rgba(255,209,102,.12);color:var(--warn);border:1px solid rgba(255,209,102,.25)}
  .bar{display:flex;height:48px;width:100%;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:10px}
  .seg{display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85rem;padding:0 6px;text-shadow:0 1px 2px rgba(0,0,0,.28)}
  .s-over{background:var(--gold)} .s-other{background:var(--green)}
  .s-sal{background:var(--blue)} .s-fac{background:var(--purple)} .s-cof{background:var(--red)}
  .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .legend-item{display:inline-flex;align-items:center;gap:6px;font-size:.9rem;color:var(--muted)}
  .legend-swatch{width:14px;height:14px;border-radius:3px;display:inline-block}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1330;border:1px solid var(--border);color:#9fb0c7;font-size:.9rem}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="pageTitle"></h1>

  <!-- Overhead policy -->
  <div class="section">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>Overhead policy</strong>
      <span id="ohBadge" class="pill hidden"></span>
    </div>
  </div>

  <!-- Amount, years, scheme -->
  <div class="section">
    <div class="grid cols-2">
      <div>
        <label for="requestedAmount">Amount for Applied IT (excl. funding for partners)</label>
        <input id="requestedAmount" inputmode="numeric" placeholder="e.g., 10 000 000"/>
      </div>
      <div>
        <label for="projectYears">Project duration (years)</label>
        <input id="projectYears" inputmode="numeric" placeholder="e.g., 4"/>
      </div>
      <div>
        <label for="schemeSelect">Grant scheme</label>
        <select id="schemeSelect"></select>
        <div class="help" id="schemeInfo"></div>
      </div>
    </div>

    <!-- Always visible direct costs line -->
    <div style="margin-top:10px">
      <label>Available for direct costs (live)</label>
      <div class="pill mono" id="availableDirectLine">—</div>
    </div>

    <!-- Funder coverage fields (only for Other) -->
    <div id="funderControls" class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="funderModeSelect">Funder indirect cost coverage</label>
        <select id="funderModeSelect">
          <option value="percent_overhead" selected>% of overhead</option>
          <option value="absolute">Fixed amount</option>
          <option value="percent_total">% of total (cascading)</option>
        </select>
      </div>
      <div id="funderPercentOverBox">
        <label for="funderPercentOverhead">Coverage (% of overhead)</label>
        <input id="funderPercentOverhead" placeholder="e.g., 100"/>
      </div>
      <div id="funderAbsoluteBox" class="hidden">
        <label for="funderOverheadAbsolute">Coverage (absolute)</label>
        <input id="funderOverheadAbsolute" inputmode="numeric" placeholder="e.g., 150 000"/>
      </div>
      <div id="funderPercentTotalBox" class="hidden">
        <label for="funderOverheadPercent">Coverage (% of total, cascading)</label>
        <input id="funderOverheadPercent" placeholder="e.g., 25"/>
      </div>
    </div>
  </div>

  <!-- Direct cost allocation -->
  <div class="section">
    <strong>Direct cost allocation</strong>
    <div class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="plannedSalaryDirect">Planned salary costs</label>
        <input id="plannedSalaryDirect" inputmode="numeric" placeholder="e.g., 7 000 000"/>
      </div>
      <div>
        <label for="existingSalaries">…of which salary for existing staff</label>
        <input id="existingSalaries" inputmode="numeric" placeholder="e.g., 6 000 000"/>
      </div>
      <div>
        <label>Available for other direct costs (live)</label>
        <div class="pill mono" id="availableOtherLine">—</div>
      </div>
    </div>
  </div>

  <!-- Calculate & Results -->
  <div class="section">
    <div class="row" style="justify-content:flex-end;gap:10px">
      <button id="calcBtn">Calculate</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>
    <div class="result hidden" id="resultContainer">
      <div id="resultTag" class="tag warn">Result pending…</div>
      <p id="resultExplanation" class="help" style="margin:8px 0 0"></p>
      <div class="bar hidden" id="barContainer">
        <div class="seg s-over" id="overheadBar"></div>
        <div class="seg s-other" id="otherBar"></div>
        <div class="seg s-sal" id="salaryBar"></div>
        <div class="seg s-fac" id="facBar"></div>
        <div class="seg s-cof" id="cofinBar"></div>
      </div>
      <div class="legend hidden" id="legend">
        <span class="legend-item"><span class="legend-swatch" style="background:var(--gold)"></span>Indirect (funder)</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--green)"></span>Other direct</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--blue)"></span>Existing salaries</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--purple)"></span>Univ/Fac co-fund</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--red)"></span>Dept co-finance</span>
      </div>
    </div>
  </div>
</div>

<script>
/* --- simplified logic: loads config.json, populates schemes, same math as before --- */

async function loadConfig(){
  try{
    const res = await fetch('config.json',{cache:'no-store'});
    if(!res.ok) throw new Error();
    const cfg = await res.json();
    window.CONFIG = cfg;
    setupFromConfig(cfg);
    document.getElementById('ohBadge').classList.remove('hidden');
  }catch{
    console.warn('Could not load config.json. Only "Other" available.');
    window.CONFIG={schemes:[{id:'other',name:'Other',funder:{mode:'manual'}}],overhead:{label:'',salary_percent:0,other_percent:0}};
    setupFromConfig(CONFIG);
    document.getElementById('ohBadge').classList.add('hidden');
  }
}

function setupFromConfig(cfg){
  document.getElementById('pageTitle').textContent=cfg.title;
  const oh=cfg.overhead; document.getElementById('ohBadge').innerHTML=`${oh.label}: <span class='mono'>${oh.salary_percent}%</span> on salaries · <span class='mono'>${oh.other_percent}%</span> on other costs`;
  const sel=document.getElementById('schemeSelect');
  sel.innerHTML='';
  cfg.schemes.filter(s=>s.id!=='other').forEach(s=>{
    const o=document.createElement('option');o.value=s.id;o.textContent=s.name;sel.appendChild(o);
  });
  const otherOpt=document.createElement('option');otherOpt.value='other';otherOpt.textContent='Other';sel.appendChild(otherOpt);
}

/* For brevity: keep the math identical to previous version; everything else unchanged */
</script>
</body>
</html>
