<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Research Funding Financial Attractiveness Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      max-width: 600px;
    }
    h1 {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 0.5em;
      box-sizing: border-box;
    }
    .radio-group {
      display: flex;
      gap: 1em;
      margin-top: 0.5em;
    }
    .radio-group input {
      width: auto;
      margin-top: 0.2em;
    }
    button {
      margin-top: 1.5em;
      padding: 10px;
      cursor: pointer;
      font-size: 1rem;
    }
    .info-text {
      margin-top: 0.5em;
      font-style: italic;
      color: #555;
    }
    .result {
      margin-top: 2em;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ccc;
    }
    #resultEvaluation {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 0.5em;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<h1>Research Funding Financial Attractiveness Calculator</h1>

<div>
  <!-- 1) Department overhead rate (on total cost) -->
  <label for="deptOverheadPercent">
    1. Department overhead rate (%):
  </label>
  <input
    type="text"
    id="deptOverheadPercent"
    placeholder="e.g. 25"
    onblur="formatInputValueAndRecompute(this)"
  />

  <!-- 2) Total requested amount -->
  <label for="requestedAmount">
    2. Total project budget:
  </label>
  <input
    type="text"
    id="requestedAmount"
    placeholder="e.g. 1 000 000"
    onblur="formatInputValueAndRecompute(this)"
  />

  <!-- 3) Funder overhead coverage type -->
  <label>
    3. How is the funder's contribution to indirect costs given?
  </label>
  <div class="radio-group">
    <label>
      <input
        type="radio"
        name="fundingCoverageType"
        value="percent"
        checked
        onchange="toggleCoverageInput(); updateLeftoverDisplay();"
      />
      Percentage
    </label>
    <label>
      <input
        type="radio"
        name="fundingCoverageType"
        value="absolute"
        onchange="toggleCoverageInput(); updateLeftoverDisplay();"
      />
      Fixed Amount
    </label>
  </div>

  <!-- Overhead coverage as percent -->
  <div id="coveragePercentContainer">
    <label for="fundingOverheadPercent">
      Funder contribution to indirect costs (%):
    </label>
    <input
      type="text"
      id="fundingOverheadPercent"
      placeholder="e.g. 15"
      onblur="formatInputValueAndRecompute(this)"
    />
  </div>

  <!-- Overhead coverage as fixed amount -->
  <div id="coverageAbsoluteContainer" class="hidden">
    <label for="fundingOverheadAbsolute">
      Funder contribution to indirect costs (fixed):
    </label>
    <input
      type="text"
      id="fundingOverheadAbsolute"
      placeholder="e.g. 150 000"
      onblur="formatInputValueAndRecompute(this)"
    />
  </div>


  <!-- 5) Existing salaries (with clamping) -->
  <label for="existingSalaries">
    5. Total amount allocated to cover salaries for existing staff:
  </label>
<!-- 4) Display leftover for direct costs = requested - coverageUsed -->
  <p class="info-text">
    Budget remaining for direct costs (including salaries) after contribution to indirect costs:
    <strong id="leftoverDisplay">-</strong>
  </p>
  <input
    type="text"
    id="existingSalaries"
    placeholder="e.g. 600 000"
    onblur="formatInputValueAndClamp(this)"
  />

  <!-- 6) Calculate button -->
  <button onclick="calculateAttractiveness()">
    Calculate financial attractiveness
  </button>

  <div class="result hidden" id="resultContainer">
    <div id="resultEvaluation"></div>
    <p id="resultExplanation"></p>
  </div>
</div>

<script>
  /********************************************************
   * HELPER FUNCTIONS
   *******************************************************/
  /**
   * Insert spaces as thousand separators in an integer.
   * Example: 1000000 -> "1 000 000"
   */
  function addSpaceThousandSeparators(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  }

  /**
   * Parse a string with space thousand separators back to an integer.
   */
  function parseSpaceSeparatedInt(str) {
    if (!str) return 0;
    const cleaned = str.replace(/\s+/g, '');
    const val = parseInt(cleaned, 10);
    return isNaN(val) ? 0 : val;
  }

  /**
   * Remove all non-digit characters, parse as integer,
   * then reformat with spaces as thousand separators.
   */
  function formatInputValue(inputEl) {
    const raw = inputEl.value.replace(/[^\d]/g, '');
    if (!raw) {
      inputEl.value = '';
      return;
    }
    const number = parseInt(raw, 10);
    if (isNaN(number)) {
      inputEl.value = '';
      return;
    }
    inputEl.value = addSpaceThousandSeparators(number);
  }

  /**
   * On blur, format the field and then update leftover if needed.
   */
  function formatInputValueAndRecompute(inputEl) {
    formatInputValue(inputEl);
    updateLeftoverDisplay();
  }

  /**
   * Show/hide overhead coverage input (percent vs. absolute).
   */
  function toggleCoverageInput() {
    const coverageType = document.querySelector('input[name="fundingCoverageType"]:checked').value;
    const percentContainer = document.getElementById('coveragePercentContainer');
    const absoluteContainer = document.getElementById('coverageAbsoluteContainer');

    if (coverageType === 'percent') {
      percentContainer.classList.remove('hidden');
      absoluteContainer.classList.add('hidden');
    } else {
      percentContainer.classList.add('hidden');
      absoluteContainer.classList.remove('hidden');
    }
  }

  /********************************************************
   * CALCULATE "DEPARTMENT OVERHEAD NEEDED" AND "COVERAGE USED"
   *******************************************************/
  /**
   * Department overhead needed = (deptOverheadPercent / 100) * requestedAmount
   */
  function getDeptOverheadNeeded() {
    const deptOverheadPercent = parseSpaceSeparatedInt(document.getElementById('deptOverheadPercent').value);
    const requestedAmount = parseSpaceSeparatedInt(document.getElementById('requestedAmount').value);
    return Math.floor((deptOverheadPercent / 100) * requestedAmount);
  }

  /**
   * Funder overhead portion (if percent or absolute).
   * coverageOffered = min(funder overhead absolute or % of total, total requested).
   */
  function getFunderOverheadOffered() {
    const requestedAmount = parseSpaceSeparatedInt(document.getElementById('requestedAmount').value);
    const coverageType = document.querySelector('input[name="fundingCoverageType"]:checked').value;

    let coverageOffered = 0;
    if (coverageType === 'percent') {
      const overheadPercent = parseSpaceSeparatedInt(document.getElementById('fundingOverheadPercent').value);
      coverageOffered = Math.floor((overheadPercent / 100) * requestedAmount);
    } else {
      const overheadAbsolute = parseSpaceSeparatedInt(document.getElementById('fundingOverheadAbsolute').value);
      coverageOffered = Math.min(overheadAbsolute, requestedAmount);
    }
    return coverageOffered;
  }

  /**
   * coverageUsed = min(deptOverheadNeeded, funderOverheadOffered).
   * The funder only covers overhead up to the amount needed by the department.
   */
  function getCoverageUsed() {
    const deptOverheadNeeded = getDeptOverheadNeeded();
    const funderOverheadOffered = getFunderOverheadOffered();
    return Math.min(deptOverheadNeeded, funderOverheadOffered);
  }

  /**
   * leftover for direct costs = requestedAmount - coverageUsed
   * Because only the portion the funder actually pays for overhead is "lost" from direct costs.
   * If coverageUsed < deptOverheadNeeded, the rest must be co-financed (but that doesn't affect direct costs from the funder).
   */
  function getLeftoverForDirectCosts() {
    const requestedAmount = parseSpaceSeparatedInt(document.getElementById('requestedAmount').value);
    const coverageUsed = getCoverageUsed();
    const leftover = requestedAmount - coverageUsed;
    return leftover > 0 ? leftover : 0;
  }

  /**
   * Update leftover displayed in the UI.
   */
  function updateLeftoverDisplay() {
    const leftover = getLeftoverForDirectCosts();
    if (leftover <= 0) {
      document.getElementById('leftoverDisplay').textContent = '0';
      return;
    }
    document.getElementById('leftoverDisplay').textContent = addSpaceThousandSeparators(leftover);
  }

  /********************************************************
   * SALARY CLAMPING
   * existingSalaries <= leftoverForDirectCosts
   *******************************************************/
  function formatInputValueAndClamp(inputEl) {
    formatInputValue(inputEl);

    const leftover = getLeftoverForDirectCosts();
    let salaryValue = parseSpaceSeparatedInt(inputEl.value);
    if (salaryValue > leftover) {
      salaryValue = leftover;
      inputEl.value = addSpaceThousandSeparators(salaryValue);
    }
  }

  /********************************************************
   * FINAL ATTRACTIVENESS CALCULATION
   * coFinancingRequired = deptOverheadNeeded - coverageUsed (if positive)
   * existingSalaries > coFinancingRequired => GOOD
   *******************************************************/
  function calculateAttractiveness() {
    const deptOverheadNeeded = getDeptOverheadNeeded();
    const coverageUsed = getCoverageUsed();
    const shortfall = deptOverheadNeeded - coverageUsed;
    const coFinancingRequired = shortfall > 0 ? shortfall : 0;

    const existingSalaries = parseSpaceSeparatedInt(document.getElementById('existingSalaries').value);

    // Evaluate
    let evaluation, explanation;
    if (existingSalaries > coFinancingRequired) {
      evaluation = 'GOOD';
      explanation = `The amount allocated to existing salaries (${addSpaceThousandSeparators(existingSalaries)}) is greater than the required co-financing (${addSpaceThousandSeparators(coFinancingRequired)}).`;
    } else {
      evaluation = 'LESS ATTRACTIVE';
      explanation = `The required co-financing (${addSpaceThousandSeparators(coFinancingRequired)}) is more than the amount allocated to existing salaries (${addSpaceThousandSeparators(existingSalaries)}).`;
    }

    // Show final result
    document.getElementById('resultEvaluation').textContent = `${evaluation}`;
    document.getElementById('resultExplanation').textContent = explanation;
    document.getElementById('resultContainer').classList.remove('hidden');
  }
</script>

</body>
</html>
