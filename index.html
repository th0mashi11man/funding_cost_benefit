<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Research Funding Financial Cost-Benefit Calculator</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#11192f; --muted:#9fb0c7; --text:#e6eef7;
      --accent:#7bbfff; --ok:#5bd69f; --warn:#ffd166; --bad:#ff6b6b;
      --gold:#f1c232; --green:#93c47d; --blue:#6fa8dc; --red:#e06666;
      --border:rgba(255,255,255,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      margin:0; color:var(--text); background:linear-gradient(180deg,#0b1020 0%, #0e1430 100%);
    }
    .wrap{max-width:920px; margin:32px auto; padding:24px;}
    h1{margin:0 0 6px; font-size:clamp(1.2rem,2.4vw,1.6rem)}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:18px 18px 6px; box-shadow:0 10px 30px rgba(0,0,0,0.25)}
    .grid{display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
    .col-12{grid-column:span 12}
    @media (min-width:720px){.col-6{grid-column:span 6}}

    label{display:block; font-weight:600; margin:8px 0 6px}
    input[type="text"], input[type="number"], select{width:100%; background:#0b1330; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:1rem}
    .row{display:flex; gap:10px; align-items:center}
    .radio-group{display:flex; gap:14px; margin-top:6px}
    .radio{display:flex; gap:8px; align-items:center}

    button{background:var(--accent); color:#071225; font-weight:700; border:none; border-radius:12px; padding:12px 16px; cursor:pointer; font-size:1rem; margin-top:8px}
    button.secondary{background:transparent; color:var(--muted); border:1px solid var(--border)}

    .result{margin-top:18px; background:#0d1538; border:1px solid var(--border); padding:16px; border-radius:12px; position:relative}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; letter-spacing:.2px}
    .ok{background:rgba(91,214,159,.12); color:var(--ok); border:1px solid rgba(91,214,159,.25)}
    .bad{background:rgba(255,107,107,.12); color:var(--bad); border:1px solid rgba(255,107,107,.25)}
    .warn{background:rgba(255,209,102,.12); color:var(--warn); border:1px solid rgba(255,209,102,.25)}

    .bar-container{display:flex; height:48px; width:100%; border:1px solid var(--border); border-radius:10px; overflow:hidden; margin-top:12px}
    .bar-segment{display:flex; align-items:center; justify-content:center; font-weight:800; text-align:center; white-space:normal; padding:0 6px; font-size:.85rem; text-shadow:0 1px 2px rgba(0,0,0,.28)}
    .bar-overhead{background:var(--gold)}
    .bar-other{background:var(--green)}
    .bar-salary{background:var(--blue)}
    .bar-cofin{background:var(--red)}

    .hidden{display:none}
    .row-end{display:flex; gap:10px; justify-content:flex-end; margin-top:8px}
    .legend{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .legend .chip{display:inline-flex; gap:8px; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0b1330; color:var(--muted); font-size:.85rem}
    .dot{width:10px; height:10px; border-radius:50%}
    .dot.o{background:var(--gold)} .dot.oth{background:var(--green)} .dot.s{background:var(--blue)} .dot.c{background:var(--red)}

    .inline-mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .help{font-size:.9rem; color:var(--muted)}
    .err{color:var(--bad); font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Research Funding Financial Cost-Benefit Calculator</h1>

    <div class="card">
      <div class="grid">
        <div class="col-6">
          <label for="deptOverheadPercent">1) Overhead rate (%)</label>
          <input id="deptOverheadPercent" inputmode="decimal" placeholder="e.g., 50" />
        </div>
        <div class="col-6">
          <label for="requestedAmount">2) Total project budget applied for</label>
          <input id="requestedAmount" inputmode="numeric" placeholder="e.g., 1,000,000" />
        </div>

        <div class="col-12">
          <label>3) How is the funder's coverage of indirect costs given? <span class="help">(if the funder doesn’t cover any indirect costs, put 0)</span></label>
          <div class="radio-group" role="radiogroup" aria-label="Funder coverage type">
            <label class="radio"><input type="radio" name="funderCoverageType" value="percent" checked /> Percentage</label>
            <label class="radio"><input type="radio" name="funderCoverageType" value="absolute" /> Fixed amount</label>
          </div>
        </div>

        <div class="col-6" id="funderPercentContainer">
          <label for="funderOverheadPercent">Funder indirect cost coverage (%)</label>
          <input id="funderOverheadPercent" inputmode="decimal" placeholder="e.g., 20" />
        </div>
        <div class="col-6 hidden" id="funderAbsoluteContainer">
          <label for="funderOverheadAbsolute">Funder overhead coverage (absolute)</label>
          <input id="funderOverheadAbsolute" inputmode="numeric" placeholder="e.g., 150000" />
        </div>

        <div class="col-12">
          <label>Available funding for direct costs:</label>
          <div><strong id="availableDirectLine" class="inline-mono">–</strong></div>
          <div id="directWarn" class="err hidden">Enter requested amount and overheads to compute direct costs.</div>
        </div>

        <div class="col-12">
          <label for="existingSalaries">4) Amount allocated to existing staff salaries</label>
          <input id="existingSalaries" inputmode="numeric" placeholder="e.g., 600,000" />
        </div>
      </div>

      <div class="row-end">
        <button id="calcBtn" aria-label="Calculate financial attractiveness">Calculate</button>
        <button id="resetBtn" class="secondary" aria-label="Reset inputs">Reset</button>
      </div>

      <div class="result hidden" id="resultContainer" aria-live="polite">
        <div id="resultTag" class="tag warn">Result pending…</div>
        <p id="resultExplanation" class="help" style="margin-top:10px"></p>

        <div class="bar-container hidden" id="barContainer">
          <div class="bar-segment bar-overhead" id="overheadBar" style="flex:0"></div>
          <div class="bar-segment bar-other"    id="otherBar"    style="flex:0"></div>
          <div class="bar-segment bar-salary"   id="salaryBar"   style="flex:0"></div>
          <div class="bar-segment bar-cofin"    id="cofinBar"    style="flex:0"></div>
        </div>
        <div class="legend">
          <span class="chip"><span class="dot o"></span>Indirect covered</span>
          <span class="chip"><span class="dot oth"></span>Other direct</span>
          <span class="chip"><span class="dot s"></span>Existing salaries</span>
          <span class="chip"><span class="dot c"></span>Co-finance</span>
        </div>

        <details style="margin-top:12px">
          <summary>Calculation details (click to expand)</summary>
          <div id="numbersDump" class="inline-mono" style="margin-top:8px"></div>
        </details>
      </div>
    </div>
  </div>

<script>
  // ---------- Utilities ----------
  const el = id => document.getElementById(id);
  const fmt = n => (isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:0}) : '–');
  const cleanNum = (str) => {
    if (!str) return 0;
    const s = String(str).replace(/[^\d.,\s]/g,'').replace(/\s+/g,'');
    const lastComma = s.lastIndexOf(',');
    const lastDot   = s.lastIndexOf('.');
    let decIdx = Math.max(lastComma, lastDot);
    if (decIdx >= 0) {
      const intPart = s.slice(0, decIdx).replace(/[.,]/g,'');
      const decPart = s.slice(decIdx+1).replace(/[.,]/g,'');
      return Number(intPart + '.' + decPart) || 0;
    }
    return Number(s.replace(/[.,]/g,'')) || 0;
  };
  const clamp = (x,min,max) => Math.max(min, Math.min(x, max));

  // ---------- Elements ----------
  const deptOverheadPercent = el('deptOverheadPercent');
  const requestedAmount     = el('requestedAmount');
  const funderTypeRadios    = document.querySelectorAll('input[name="funderCoverageType"]');
  const funderPercent       = el('funderOverheadPercent');
  const funderAbsolute      = el('funderOverheadAbsolute');
  const funderPercentBox    = el('funderPercentContainer');
  const funderAbsoluteBox   = el('funderAbsoluteContainer');
  const availableDirectLine = el('availableDirectLine');
  const directWarn          = el('directWarn');
  const existingSalaries    = el('existingSalaries');
  const resultContainer     = el('resultContainer');
  const resultTag           = el('resultTag');
  const resultExplanation   = el('resultExplanation');
  const barContainer        = el('barContainer');
  const bars = {
    overhead: el('overheadBar'), other: el('otherBar'), salary: el('salaryBar'), cofin: el('cofinBar')
  };
  const numbersDump         = el('numbersDump');

  // ---------- Logic ----------
  function getCascadingOverhead(total, percent){
    const p = Math.max(0, cleanNum(percent));
    if (p <= 0 || total <= 0) return 0;
    const r = p/100;
    return Math.round(total * (r/(1+r)));
  }

  function getDeptOverhead(total){
    return getCascadingOverhead(total, deptOverheadPercent.value);
  }

  function getFunderOverhead(total){
    const type = [...funderTypeRadios].find(r=>r.checked)?.value || 'percent';
    if (type === 'percent') return getCascadingOverhead(total, funderPercent.value);
    const abs = Math.round(cleanNum(funderAbsolute.value));
    return clamp(abs, 0, Math.max(0,total));
  }

  function computeAvailableDirect(){
    const total = Math.round(cleanNum(requestedAmount.value));
    if (total <= 0) return 0;
    const dept = getDeptOverhead(total);
    const fund = getFunderOverhead(total);
    if (fund <= 0) return total; // all direct
    const used = Math.min(dept, fund);
    return Math.max(0, total - used);
  }

  function updateAvailableDirect(){
    const direct = computeAvailableDirect();
    availableDirectLine.textContent = fmt(direct);
    directWarn.classList.toggle('hidden', direct > 0);
    const sal = Math.round(cleanNum(existingSalaries.value));
    if (sal > direct) existingSalaries.value = fmt(direct);
  }

  function toggleFunderFields(){
    const type = [...funderTypeRadios].find(r=>r.checked)?.value || 'percent';
    funderPercentBox.classList.toggle('hidden', type !== 'percent');
    funderAbsoluteBox.classList.toggle('hidden', type !== 'absolute');
  }

  function label2Lines(lbl, val){
    return val > 0 ? `${lbl}<br>${fmt(val)}` : '';
  }

  function calculate(){
    const total = Math.round(cleanNum(requestedAmount.value));
    const deptP = cleanNum(deptOverheadPercent.value);

    const deptOver   = getDeptOverhead(total);
    const fundOver   = getFunderOverhead(total);

    let coverageUsed = 0, finalDirect = 0, coFin = deptOver;
    if (fundOver <= 0){
      finalDirect = total;
      coverageUsed = 0;
      coFin = deptOver;
    } else {
      coverageUsed = Math.min(deptOver, fundOver);
      finalDirect  = Math.max(0, total - coverageUsed);
      coFin        = Math.max(0, deptOver - coverageUsed);
    }

    let userSalaries = Math.round(cleanNum(existingSalaries.value));
    userSalaries = clamp(userSalaries, 0, finalDirect);
    if (userSalaries !== Math.round(cleanNum(existingSalaries.value))){
      existingSalaries.value = fmt(userSalaries);
    }

    let other = Math.max(0, finalDirect - userSalaries);

    // Evaluation
    let tagClass = 'warn';
    let tagText = 'UNCLEAR cost-benefit advantage';
    let explanation = `Co-financing (${fmt(coFin)}) is greater than existing-salary coverage (${fmt(userSalaries)}).`;
    if (userSalaries > coFin){
      tagClass = 'ok';
      tagText = 'CLEAR cost-benefit advantage';
      explanation = `Existing-salary coverage (${fmt(userSalaries)}) exceeds co-financing (${fmt(coFin)}).`;
    } else if (userSalaries === coFin){
      tagClass = 'warn';
      tagText = 'BREAK-EVEN';
      explanation = `Existing-salary coverage equals co-financing (${fmt(coFin)}).`;
    }

    resultTag.className = `tag ${tagClass}`;
    resultTag.textContent = tagText;
    resultExplanation.textContent = explanation;
    resultContainer.classList.remove('hidden');

    const sumSeg = coverageUsed + other + userSalaries + coFin;
    if (sumSeg <= 0){
      barContainer.classList.add('hidden');
    } else {
      barContainer.classList.remove('hidden');
      const frac = (x)=> x>0 ? x/sumSeg : 0;
      bars.overhead.style.flex = String(frac(coverageUsed));
      bars.other.style.flex    = String(frac(other));
      bars.salary.style.flex   = String(frac(userSalaries));
      bars.cofin.style.flex    = String(frac(coFin));

      bars.overhead.innerHTML = label2Lines('Indirect', coverageUsed);
      bars.other.innerHTML    = label2Lines('Other costs', other);
      bars.salary.innerHTML   = label2Lines('Ex. salaries', userSalaries);
      bars.cofin.innerHTML    = label2Lines('Co-finance', coFin);
    }

    numbersDump.innerHTML = [
      `Requested: ${fmt(total)}`,
      `Dept overhead %: ${isFinite(deptP)?deptP:0}`,
      `Dept overhead (calc): ${fmt(deptOver)}`,
      `Funder overhead (entered/calc): ${fmt(fundOver)}`,
      `Coverage used (min dept,funder): ${fmt(coverageUsed)}`,
      `Final direct: ${fmt(finalDirect)}`,
      `Existing salaries (used): ${fmt(userSalaries)}`,
      `Other direct: ${fmt(other)}`,
      `Co-finance: ${fmt(coFin)}`
    ].join('<br>');
  }

  function resetAll(){
    [deptOverheadPercent, requestedAmount, funderPercent, funderAbsolute, existingSalaries].forEach(i=>i.value='');
    availableDirectLine.textContent = '–';
    resultContainer.classList.add('hidden');
    barContainer.classList.add('hidden');
    toggleFunderFields();
  }

  // ---------- Events ----------
  ['input','blur'].forEach(evt=>{
    deptOverheadPercent.addEventListener(evt, updateAvailableDirect);
    requestedAmount.addEventListener(evt, updateAvailableDirect);
    funderPercent.addEventListener(evt, updateAvailableDirect);
    funderAbsolute.addEventListener(evt, updateAvailableDirect);
    existingSalaries.addEventListener(evt, updateAvailableDirect);
  });
  funderTypeRadios.forEach(r=>r.addEventListener('change', ()=>{toggleFunderFields(); updateAvailableDirect()}));
  document.getElementById('calcBtn').addEventListener('click', calculate);
  document.getElementById('resetBtn').addEventListener('click', resetAll);

  // init
  toggleFunderFields();
  updateAvailableDirect();
</script>
</body>
</html>
