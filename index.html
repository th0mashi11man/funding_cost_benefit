<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Research Funding Financial Cost-Benefit Calculator</title>
<style>
  :root{
    --bg:#0b1020; --panel:#11192f; --muted:#9fb0c7; --text:#e6eef7;
    --accent:#7bbfff; --ok:#5bd69f; --warn:#ffd166; --bad:#ff6b6b;
    --gold:#f1c232; --green:#93c47d; --blue:#6fa8dc; --red:#e06666; --purple:#b37bd6;
    --border:rgba(255,255,255,0.14); --panel2:#0d1431;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#0b1020; color:var(--text)}
  .wrap{max-width:980px; margin:32px auto; padding:0 16px}
  h1{margin:0 0 14px; font-size:clamp(1.1rem,2.2vw,1.6rem)}
  .section{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; margin-top:16px}
  .grid{display:grid; gap:14px}
  @media (min-width:820px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  label{display:block; font-weight:600; margin:6px 0}
  input,select{width:100%; background:#0b1330; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:1rem}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start}
  .help{font-size:.9rem; color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-variant-numeric:tabular-nums}
  button{background:var(--accent); color:#071225; font-weight:700; border:none; border-radius:10px; padding:12px 16px; cursor:pointer; font-size:1rem}
  button.secondary{background:transparent; color:#9fb0c7; border:1px solid var(--border)}
  .result{background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:14px; margin-top:14px}
  .tag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700}
  .ok{background:rgba(91,214,159,.12); color:var(--ok); border:1px solid rgba(91,214,159,.25)}
  .warn{background:rgba(255,209,102,.12); color:var(--warn); border:1px solid rgba(255,209,102,.25)}
  .bar{display:flex; height:48px; width:100%; border:1px solid var(--border); border-radius:10px; overflow:hidden; margin-top:10px}
  .seg{display:flex; align-items:center; justify-content:center; font-weight:800; font-size:.85rem; padding:0 6px; text-shadow:0 1px 2px rgba(0,0,0,.28)}
  .s-over{background:var(--gold)} .s-other{background:var(--green)}
  .s-sal{background:var(--blue)} .s-fac{background:var(--purple)} .s-cof{background:var(--red)}
  details{margin-top:10px}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0b1330; border:1px solid var(--border); color:#9fb0c7; font-size:.9rem}
  .legend{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
  .legend-item{display:inline-flex; align-items:center; gap:6px; font-size:.9rem; color:var(--muted)}
  .legend-swatch{width:14px; height:14px; border-radius:3px; display:inline-block}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="pageTitle">Research Funding Financial Cost-Benefit Calculator</h1>

  <!-- Overhead policy (informational only) -->
  <div class="section">
    <div class="row" style="justify-content:space-between; align-items:center">
      <strong>Overhead policy</strong>
      <span id="ohBadge" class="pill hidden"><!-- set dynamically --></span>
    </div>
  </div>

  <!-- Amount, years & grant scheme -->
  <div class="section">
    <div class="grid cols-2">
      <div>
        <label for="requestedAmount">Amount to Applied IT (excl. other institutions)</label>
        <input id="requestedAmount" data-decimal="false" inputmode="numeric" placeholder="e.g., 10 000 000" />
      </div>
      <div>
        <label for="projectYears">Project duration (years)</label>
        <input id="projectYears" data-decimal="false" inputmode="numeric" placeholder="e.g., 4" />
      </div>

      <div>
        <label for="schemeSelect">Grant scheme</label>
        <select id="schemeSelect"></select>
        <div class="help" id="schemeInfo"></div>
      </div>
    </div>

    <!-- Funder coverage controls (visible ONLY when scheme = 'other') -->
    <div id="funderControls" class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="funderModeSelect">Funder indirect cost coverage</label>
        <select id="funderModeSelect">
          <option value="percent_overhead" selected>% of overhead</option>
          <option value="absolute">Fixed amount</option>
          <option value="percent_total">% of total (cascading)</option>
        </select>
      </div>
      <div id="funderPercentOverBox">
        <label for="funderPercentOverhead">Coverage (% of overhead)</label>
        <input id="funderPercentOverhead" data-decimal="true" placeholder="e.g., 100" />
      </div>
      <div id="funderAbsoluteBox" class="hidden">
        <label for="funderOverheadAbsolute">Coverage (absolute)</label>
        <input id="funderOverheadAbsolute" data-decimal="false" inputmode="numeric" placeholder="e.g., 150 000" />
      </div>
      <div id="funderPercentTotalBox" class="hidden">
        <label for="funderOverheadPercent">Coverage (% of total, cascading)</label>
        <input id="funderOverheadPercent" data-decimal="true" placeholder="e.g., 25" />
      </div>

      <div>
        <label>Available for direct costs (live)</label>
        <div class="pill mono" id="availableDirectLine">—</div>
      </div>
    </div>
  </div>

  <!-- Direct cost allocation -->
  <div class="section">
    <strong>Direct cost allocation</strong>
    <div class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="plannedSalaryDirect">Planned salary costs (direct)</label>
        <input id="plannedSalaryDirect" data-decimal="false" inputmode="numeric" placeholder="e.g., 7 000 000" />
      </div>
      <div>
        <label for="existingSalaries">…of which salary for existing staff</label>
        <input id="existingSalaries" data-decimal="false" inputmode="numeric" placeholder="e.g., 6 000 000" />
      </div>
      <div>
        <label>Available for other direct costs (live)</label>
        <div class="pill mono" id="availableOtherLine">—</div>
      </div>
    </div>
  </div>

  <!-- Calculate & Results -->
  <div class="section">
    <div class="row" style="justify-content:flex-end; gap:10px">
      <button id="calcBtn">Calculate</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div class="result hidden" id="resultContainer">
      <div id="resultTag" class="tag warn">Result pending…</div>
      <p id="resultExplanation" class="help" style="margin:8px 0 0"></p>

      <div class="bar hidden" id="barContainer">
        <div class="seg s-over"  id="overheadBar" style="flex:0"></div>
        <div class="seg s-other" id="otherBar"    style="flex:0"></div>
        <div class="seg s-sal"   id="salaryBar"   style="flex:0"></div>
        <div class="seg s-fac"   id="facBar"      style="flex:0"></div>
        <div class="seg s-cof"   id="cofinBar"    style="flex:0"></div>
      </div>
      <div class="legend hidden" id="legend">
        <span class="legend-item"><span class="legend-swatch" style="background:var(--gold)"></span>Indirect (funder)</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--green)"></span>Other direct</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--blue)"></span>Existing salaries</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--purple)"></span>Univ/Fac co-fund</span>
        <span class="legend-item"><span class="legend-swatch" style="background:var(--red)"></span>Dept co-finance</span>
      </div>

      <details>
        <summary>Calculation details (click to expand)</summary>
        <div id="numbersDump" class="mono" style="margin-top:8px"></div>
      </details>
    </div>
  </div>
</div>

<script>
  // ---------- helpers
  const $ = id => document.getElementById(id);
  const fmt = n => (isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:0}).replace(/,/g,' ') : '—');
  const clamp = (x,min,max)=>Math.max(min,Math.min(x,max));

  // Parse numbers typed with spaces as thousand sep and either '.' or ',' as decimal sep
  const num = s=>{
    if(!s) return 0;
    const t=String(s);
    let u=t.replace(/[^\d.,\s-]/g,'').replace(/\s+/g,'');
    const neg=/^-/.test(u); u=u.replace(/-/g,'');
    const lastComma=u.lastIndexOf(','), lastDot=u.lastIndexOf('.');
    let dec=null;
    if(lastComma>=0 || lastDot>=0) dec=(lastComma>lastDot)?',':'.';
    if(dec){
      u = u.replace(dec==='.'?/,/g:/\./g,'');
      const idx=u.indexOf(dec);
      const ip=u.slice(0,idx).replace(/[^\d]/g,'');
      const dp=u.slice(idx+1).replace(/[^\d]/g,'');
      return (neg?-1:1)*Number(ip+'.'+dp || '0');
    }else{
      return (neg?-1:1)*Number(u.replace(/[^\d]/g,'' )||'0');
    }
  };

  // Live formatter with spaces as thousand sep; keeps user's decimal sep
  function formatNumericInput(el){
    const allowDecimal = el.getAttribute('data-decimal') === 'true';
    const start = el.selectionStart ?? el.value.length;
    const original = el.value;
    const digitsBeforeCaret = (original.slice(0,start).match(/\d/g)||[]).length;

    let value = original.replace(/[^\d.,]/g,'');
    const lastComma=value.lastIndexOf(','), lastDot=value.lastIndexOf('.');
    let decSep = null;
    if(allowDecimal && (lastComma>=0 || lastDot>=0)) decSep = (lastComma>lastDot)?',':'.';

    if(decSep){ value = value.replace(decSep==='.'?/,/g:/\./g,''); }
    else { value = value.replace(/[.,]/g,''); }

    let intPart = value, fracPart='';
    if(decSep){
      const idx=value.indexOf(decSep);
      if(idx>=0){
        intPart = value.slice(0,idx);
        fracPart = value.slice(idx+1).replace(/[^\d]/g,'');
      }
    }
    intPart = intPart.replace(/[^\d]/g,'');
    const formattedInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g,' ');
    let out = formattedInt;
    if(allowDecimal && decSep && fracPart.length>0){ out += decSep + fracPart; }
    el.value = out;

    // restore caret
    const posFromDigitIndex = (str, idx)=>{
      if(idx<=0) return 0;
      let count=0;
      for(let i=0;i<str.length;i++){
        if(/\d/.test(str[i])){ count++; if(count===idx) return i+1; }
      }
      return str.length;
    };
    const newPos = posFromDigitIndex(out, digitsBeforeCaret);
    try{ el.setSelectionRange(newPos,newPos); }catch(e){}
  }

  function attachFormatters(){
    document.querySelectorAll('input[data-decimal]').forEach(el=>{
      el.addEventListener('input', ()=>{ formatNumericInput(el); updateLive(); });
      el.addEventListener('blur',  ()=>{ formatNumericInput(el); updateLive(); });
    });
  }

  // ---------- elements
  const pageTitle=$('pageTitle'), ohBadge=$('ohBadge');

  const requestedAmount=$('requestedAmount'), projectYears=$('projectYears');
  const schemeSelect=$('schemeSelect'), schemeInfo=$('schemeInfo');

  const funderControls=$('funderControls');
  const funderModeSelect=$('funderModeSelect');
  const funderPercentOverBox=$('funderPercentOverBox');
  const funderAbsoluteBox=$('funderAbsoluteBox');
  const funderPercentTotalBox=$('funderPercentTotalBox');
  const funderPercentOverhead=$('funderPercentOverhead');
  const funderOverheadAbsolute=$('funderOverheadAbsolute');
  const funderOverheadPercent=$('funderOverheadPercent');

  const availableDirectLine=$('availableDirectLine');
  const availableOtherLine=$('availableOtherLine');
  const plannedSalaryDirect=$('plannedSalaryDirect'), existingSalaries=$('existingSalaries');

  const resultContainer=$('resultContainer'), resultTag=$('resultTag'), resultExplanation=$('resultExplanation');
  const barContainer=$('barContainer'), legend=$('legend');
  const bars={overhead:$('overheadBar'), other:$('otherBar'), salary:$('salaryBar'), fac:$('facBar'), cofin:$('cofinBar')};
  const numbersDump=$('numbersDump');

  // ---------- dynamic config & schemes
  const DEFAULT_CONFIG = {
    title: "Research Funding Financial Cost-Benefit Calculator",
    overhead: { label: "ITIT 2025", salary_percent: 62, other_percent: 52 },
    defaultScheme: "vr",
    schemes: [{ "id":"other", "name":"Other", "funder":{"mode":"manual","value":null,"label":"Manual entry"}, "uf_rules":[] }]
  };
  let CONFIG = DEFAULT_CONFIG;
  let CONFIG_SOURCE = 'default'; // 'external' | 'embedded' | 'default'
  let SCHEMES = {};         // id -> {funder:{mode,value,label}, uf_rules:[...objects...]}

  // internal OH (from config)
  let salaryOH = 0.62;
  let otherOH  = 0.52;
  let activeScheme = null;

  function buildSchemesFromConfig(){
    SCHEMES = {};
    (CONFIG.schemes||[]).forEach(s=>{
      SCHEMES[s.id] = {
        name: s.name,
        funder: s.funder || {mode:'none', value:0, label:'—'},
        uf_rules: Array.isArray(s.uf_rules) ? s.uf_rules : []
      };
    });
    // ensure "other" exists and is last in the UI (we add it later when building select)
    if(!SCHEMES['other']){
      SCHEMES['other'] = { name: 'Other', funder:{mode:'manual', value:null, label:'Manual entry'}, uf_rules:[] };
    }
  }

  function populateUIFromConfig(){
    // title
    pageTitle.textContent = CONFIG.title || DEFAULT_CONFIG.title;

    // overhead badge: show only when config.json loaded from server
    if (CONFIG_SOURCE === 'external') {
      const lbl = CONFIG.overhead?.label || '—';
      const sal = CONFIG.overhead?.salary_percent ?? 0;
      const oth = CONFIG.overhead?.other_percent ?? 0;
      ohBadge.classList.remove('hidden');
      ohBadge.innerHTML = `${lbl}: <span class="mono">${sal}%</span> on salaries · <span class="mono">${oth}%</span> on other`;
    } else {
      ohBadge.classList.add('hidden');
    }

    // internal OH decimals
    const sal = CONFIG.overhead?.salary_percent ?? 62;
    const oth = CONFIG.overhead?.other_percent ?? 52;
    salaryOH = Number(sal)/100;
    otherOH  = Number(oth)/100;

    // build scheme select with default scheme at top, Other at bottom
    const sel = schemeSelect;
    sel.innerHTML = '';

    const schemesInOrder = (CONFIG.schemes||[]).filter(s=>s.id!=='other');
    const defaultId = CONFIG.defaultScheme || 'vr';

    // add all schemes except Other
    schemesInOrder.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s.id; opt.textContent = s.name;
      sel.appendChild(opt);
    });

    // always append Other as the last option
    const optOther = document.createElement('option');
    optOther.value = 'other'; optOther.textContent = 'Other';
    sel.appendChild(optOther);

    // choose default (VR), if present; else first; else Other
    const defIndex = Array.from(sel.options).findIndex(o=>o.value===defaultId);
    sel.selectedIndex = defIndex>=0 ? defIndex : 0;

    applyScheme();
  }

  // ---------- University/Faculty rules engine
  // Supported modes:
  // - percent_total: (% of total grant)
  // - fixed_per_year: (amount per year)
  // - percent_total_capped_per_year: (% of total, but cap per year)
  function computeUfAmount(rule, total, years){
    const yrs = Math.max(1, Math.round(num(years)));
    if(!rule || !rule.mode) return 0;

    if(rule.mode === 'percent_total'){
      const p = Number(rule.value || 0)/100;
      return Math.max(0, Math.round(total * p));
    }
    if(rule.mode === 'fixed_per_year'){
      const a = Number(rule.amount_per_year || 0);
      return Math.max(0, Math.round(a * yrs));
    }
    if(rule.mode === 'percent_total_capped_per_year'){
      const p = Number(rule.value || 0)/100;
      const cap = Number(rule.per_year_cap || 0);
      const raw = total * p;
      const capped = Math.min(raw, cap * yrs);
      return Math.max(0, Math.round(capped));
    }
    return 0;
  }

  function sumUfAmount(rules, total, years){
    if(!Array.isArray(rules) || rules.length===0) return {amount:0, note:'—'};
    let sum=0, notes=[];
    for(const r of rules){
      const a = computeUfAmount(r, total, years);
      sum += a;
      notes.push(r.notes || r.name || r.mode);
    }
    return {amount: sum, note: notes.join(' + ')};
  }

  // ---------- salary clamping
  function clampSalaryInputs(direct){
    let planned = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    if(planned > direct){ planned = direct; plannedSalaryDirect.value = fmt(planned); }
    let existing = Math.max(0, Math.round(num(existingSalaries.value)));
    if(existing > planned){ existing = planned; existingSalaries.value = fmt(existing); }
  }

  // ---------- core calculations (iterative effective rate via salary share)
  let lastShare = 0.5;
  function getFunderCoverage(total, deptOver){
    const mode = activeScheme.funder.mode;
    if(mode==='percent_overhead'){
      const p = activeScheme.funder.value ?? num(funderPercentOverhead.value);
      return Math.round(deptOver * Math.max(0, Math.min(p,100)) / 100);
    }
    if(mode==='percent_total'){
      const p = activeScheme.funder.value ?? num(funderOverheadPercent.value);
      const dec = Math.max(0, Math.min(p,500))/100;
      return Math.round(total * (dec/(1+dec))); // cascading on total
    }
    if(mode==='absolute'){
      const a = activeScheme.funder.value ?? num(funderOverheadAbsolute.value);
      return Math.max(0, Math.min(Math.round(a), total));
    }
    if(mode==='manual'){ // "Other"
      const m = funderModeSelect.value;
      if(m==='percent_overhead'){
        const p = num(funderPercentOverhead.value);
        return Math.round(deptOver * Math.max(0, Math.min(p,100)) / 100);
      }else if(m==='percent_total'){
        const p = num(funderOverheadPercent.value);
        const dec = Math.max(0, Math.min(p,500))/100;
        return Math.round(total * (dec/(1+dec)));
      }else{ // absolute
        const a = num(funderOverheadAbsolute.value);
        return Math.max(0, Math.min(Math.round(a), total));
      }
    }
    return 0; // 'none'
  }

  function calcWithDerivedShare(total){
    let share = lastShare;
    const rs = Math.max(0, Math.min(salaryOH,5));
    const ro = Math.max(0, Math.min(otherOH,5));
    let deptOver=0, fundCov=0, used=0, direct=0;

    for(let i=0;i<3;i++){
      const rEff = rs*share + ro*(1-share);
      deptOver = Math.round(total * (rEff/(1+rEff)));
      fundCov  = getFunderCoverage(total, deptOver);
      used     = Math.min(deptOver, fundCov);
      direct   = Math.max(0, total - used);
      const ps = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
      share    = direct>0 ? Math.max(0, Math.min(ps/direct, 1)) : 0;
    }
    lastShare = share;
    const rEff = rs*share + ro*(1-share);
    return {deptOver, fundCov, used, direct, rEff, share};
  }

  // ---------- UI logic
  function toggleFunderInputs(){
    const isOther = (schemeSelect.value==='other');
    funderControls.classList.toggle('hidden', !isOther);
    const mode = isOther ? funderModeSelect.value : 'percent_overhead';
    funderPercentOverBox.classList.toggle('hidden', !(isOther && mode==='percent_overhead'));
    funderAbsoluteBox.classList.toggle('hidden', !(isOther && mode==='absolute'));
    funderPercentTotalBox.classList.toggle('hidden', !(isOther && mode==='percent_total'));
  }

  function applyScheme(){
    const id = schemeSelect.value;
    activeScheme = SCHEMES[id];
    if(!activeScheme){ return; }

    // helper text: hide for "Other", show concise info for presets
    if(id==='other'){
      schemeInfo.textContent = '';
      schemeInfo.classList.add('hidden');
    }else{
      const label = activeScheme.funder.label || '—';
      const ufText = (activeScheme.uf_rules && activeScheme.uf_rules.length>0)
        ? 'Univ/Faculty: ' + activeScheme.uf_rules.map(r=>r.notes || r.name || r.mode).join(' + ')
        : 'Univ/Faculty: none for this scheme';
      schemeInfo.textContent = `Funder: ${label}. ${ufText}.`;
      schemeInfo.classList.remove('hidden');
    }

    toggleFunderInputs();
    updateLive();
  }

  function updateLive(){
    const total=Math.round(num(requestedAmount.value));
    if(total<=0){
      availableDirectLine.textContent='—';
      availableOtherLine.textContent='—';
      return;
    }
    const {deptOver, fundCov, used, direct} = calcWithDerivedShare(total);
    availableDirectLine.textContent = fmt(direct);

    // clamp & compute other live
    clampSalaryInputs(direct);
    const planned = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    const otherLive = Math.max(0, direct - planned);
    availableOtherLine.textContent = fmt(otherLive);
  }

  // ---------- Calculate & render
  function labelAmount(val){ return val>0 ? fmt(val) : ''; }

  function calculate(){
    const total=Math.round(num(requestedAmount.value));
    const years = projectYears.value || '1';
    const {deptOver, fundCov, used, direct, rEff, share} = calcWithDerivedShare(total);

    // Dept co-financing before Univ/Fac
    const coFinRaw = Math.max(0, deptOver - used);

    // Univ/Faculty co-funding as defined on the scheme (sum of flexible rules)
    const ufAgg = sumUfAmount(activeScheme.uf_rules, total, years);
    const facUsed = Math.min(ufAgg.amount, coFinRaw); // cannot exceed required co-finance
    const coFinNet = Math.max(0, coFinRaw - facUsed);

    // Clamp salaries & compute other
    clampSalaryInputs(direct);
    const plannedSal = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    const userSalaries = Math.max(0, Math.round(num(existingSalaries.value)));
    const other = Math.max(0, direct - plannedSal);

    let cls='warn', txt='UNCLEAR cost-benefit advantage';
    let expl=`Dept co-finance after Univ/Faculty (${fmt(coFinNet)}) is greater than existing-salary coverage (${fmt(userSalaries)}).`;
    if(userSalaries>coFinNet){ cls='ok'; txt='CLEAR cost-benefit advantage'; expl=`Existing-salary coverage (${fmt(userSalaries)}) exceeds dept co-finance after Univ/Faculty (${fmt(coFinNet)}).`; }
    else if(userSalaries===coFinNet){ cls='warn'; txt='BREAK-EVEN'; expl=`Existing-salary coverage equals dept co-finance after Univ/Faculty (${fmt(coFinNet)}).`; }

    resultTag.className='tag '+cls; resultTag.textContent=txt; resultExplanation.textContent=expl;
    resultContainer.classList.remove('hidden');

    // Bar (amounts only) + legend
    const sum=used+other+userSalaries+facUsed+coFinNet;
    if(sum<=0){ barContainer.classList.add('hidden'); legend.classList.add('hidden'); }
    else{
      barContainer.classList.remove('hidden'); legend.classList.remove('hidden');
      const frac=x=>x>0?x/sum:0;
      bars.overhead.style.flex=String(frac(used));
      bars.other.style.flex=String(frac(other));
      bars.salary.style.flex=String(frac(userSalaries));
      bars.fac.style.flex=String(frac(facUsed));
      bars.cofin.style.flex=String(frac(coFinNet));

      bars.overhead.textContent = labelAmount(used);
      bars.other.textContent    = labelAmount(other);
      bars.salary.textContent   = labelAmount(userSalaries);
      bars.fac.textContent      = labelAmount(facUsed);
      bars.cofin.textContent    = labelAmount(coFinNet);
    }

    const modeLabel = (activeScheme.funder.mode==='percent_overhead') ? '% of overhead'
                     : (activeScheme.funder.mode==='percent_total')    ? '% of total (cascading)'
                     : (activeScheme.funder.mode==='absolute')         ? 'absolute amount'
                     : (activeScheme.funder.mode==='manual')           ? 'manual'
                     : 'none';

    numbersDump.innerHTML=[
      `Scheme: ${schemeSelect.options[schemeSelect.selectedIndex].text}`,
      `Amount to Applied IT: ${fmt(total)}`,
      `Project duration: ${years} year(s)`,
      `OH policy: salaries ${(salaryOH*100).toFixed(0)}% | other ${(otherOH*100).toFixed(0)}%`,
      `Dept overhead (cascading): ${fmt(deptOver)}`,
      `Funder coverage: ${fmt(getFunderCoverage(total, deptOver))} (${modeLabel})`,
      `Coverage used (min dept,funder): ${fmt(used)}`,
      `Direct funds available: ${fmt(direct)}`,
      `Planned salary (direct): ${fmt(plannedSal)}`,
      `Existing salaries (subset): ${fmt(userSalaries)}`,
      `Other direct: ${fmt(other)}`,
      `Dept co-finance before Univ/Fac: ${fmt(coFinRaw)}`,
      `Univ/Fac co-funding (applied): ${fmt(facUsed)}${ufAgg.note?` — ${ufAgg.note}`:''}`,
      `Dept co-finance after Univ/Fac: ${fmt(coFinNet)}`
    ].join('<br>');
  }

  function resetAll(){
    requestedAmount.value=''; projectYears.value='';
    // reset to default scheme from config if available
    const defId = CONFIG.defaultScheme || 'vr';
    const defIndex = Array.from(schemeSelect.options).findIndex(o=>o.value===defId);
    schemeSelect.selectedIndex = defIndex>=0 ? defIndex : 0;
    funderModeSelect.value='percent_overhead';
    funderPercentOverhead.value=''; funderOverheadAbsolute.value=''; funderOverheadPercent.value='';
    plannedSalaryDirect.value=''; existingSalaries.value='';
    $('availableDirectLine').textContent='—'; $('availableOtherLine').textContent='—';
    resultContainer.classList.add('hidden'); barContainer.classList.add('hidden'); legend.classList.add('hidden');
    lastShare=0.5;
    applyScheme();
  }

  // ---------- events
  function attachLogicListeners(){
    funderModeSelect.addEventListener('change', ()=>{toggleFunderInputs(); updateLive();});
    schemeSelect.addEventListener('change', applyScheme);
    $('calcBtn').addEventListener('click', calculate);
    $('resetBtn').addEventListener('click', resetAll);
  }

  // ---------- config loader with external/embedded/default sources
  async function loadConfig(){
    try{
      const res = await fetch('config.json', { cache: 'no-store' });
      if(!res.ok) throw new Error('config.json not found');
      CONFIG = await res.json();
      CONFIG_SOURCE = 'external';
    }catch(e){
      // Optional embedded fallback: comment this in if you want a local default without server
      const embedded = document.getElementById('embedded-config');
      if(embedded?.textContent){
        try{ CONFIG = JSON.parse(embedded.textContent); CONFIG_SOURCE='embedded'; }
        catch{ CONFIG = DEFAULT_CONFIG; CONFIG_SOURCE='default'; }
      }else{
        CONFIG = DEFAULT_CONFIG; CONFIG_SOURCE='default';
      }
    }
    buildSchemesFromConfig();
    populateUIFromConfig();
  }

  // init
  (function init(){
    attachFormatters();
    attachLogicListeners();
    loadConfig().then(()=>{ updateLive(); });
  })();
</script>

<!--
  Optional embedded config for local file:// testing.
  If you want a local fallback, paste your config.json here and uncomment this block.
<script id="embedded-config" type="application/json">
{ }
</script>
-->
</body>
</html>
