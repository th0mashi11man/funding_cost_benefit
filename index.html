<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Research Funding Financial Cost-Benefit Calculator</title>
<style>
  :root{
    --bg:#0b1020; --panel:#11192f; --muted:#9fb0c7; --text:#e6eef7;
    --accent:#7bbfff; --ok:#5bd69f; --warn:#ffd166; --bad:#ff6b6b;
    --gold:#f1c232; --green:#93c47d; --blue:#6fa8dc; --red:#e06666; --purple:#b37bd6;
    --border:rgba(255,255,255,0.14); --panel2:#0d1431;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1020;color:var(--text)}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 14px;font-size:clamp(1.1rem,2.2vw,1.6rem)}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
  .grid{display:grid;gap:14px}
  @media (min-width:820px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  label{display:block;font-weight:600;margin:6px 0}
  input,select{width:100%;background:#0b1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:1rem}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
  .help{font-size:.9rem;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-variant-numeric:tabular-nums}
  button{background:var(--accent);color:#071225;font-weight:700;border:none;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:1rem}
  button.secondary{background:transparent;color:#9fb0c7;border:1px solid var(--border)}
  .result{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:14px}
  .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700}
  .ok{background:rgba(91,214,159,.12);color:var(--ok);border:1px solid rgba(91,214,159,.25)}
  .warn{background:rgba(255,209,102,.12);color:var(--warn);border:1px solid rgba(255,209,102,.25)}
  .bar{display:flex;height:48px;width:100%;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:10px}
  .seg{display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85rem;padding:0 6px;text-shadow:0 1px 2px rgba(0,0,0,.28)}
  .s-over{background:var(--gold)} .s-other{background:var(--green)}
  .s-sal{background:var(--blue)} .s-fac{background:var(--purple)} .s-cof{background:var(--red)}
  .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;margin-bottom:12px}
  .legend-item{display:inline-flex;align-items:center;gap:6px;font-size:.9rem;color:#9fb0c7}
  .legend-swatch{width:14px;height:14px;border-radius:3px;display:inline-block}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1330;border:1px solid var(--border);color:#9fb0c7;font-size:.9rem}
  .hidden{display:none}
  .error{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.35);color:#ff9b9b}

  /* Summary view */
  .details-grid{display:grid;gap:10px}
  @media (min-width:820px){.details-grid.cols-2{grid-template-columns:1fr 1fr}}
  .kv{display:grid;grid-template-columns:1fr auto;gap:6px 12px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0b1330}
  .kv .k{color:var(--muted)}
  .kv .v{font-weight:700}
  .section-title{margin:12px 0 6px;font-weight:800;color:#cfe2f5}
  .summary-box{background:#0b1330;border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:14px}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="pageTitle"></h1>

  <!-- Overhead policy -->
  <div class="section">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>Overhead policy</strong>
      <span id="ohBadge" class="pill hidden"></span>
    </div>
    <div id="configWarn" class="pill error hidden" style="margin-top:8px">Couldn’t load <span class="mono">config.json</span>. Using fallback.</div>
  </div>

  <!-- Amount, years, scheme -->
  <div class="section">
    <div class="grid cols-2">
      <div>
        <label for="requestedAmount">Amount for Applied IT (excl. funding for partners)</label>
        <input id="requestedAmount" data-decimal="false" inputmode="numeric" placeholder="e.g., 10 000 000"/>
      </div>
      <div>
        <label for="projectYears">Project duration (years)</label>
        <input id="projectYears" data-decimal="false" inputmode="numeric" placeholder="e.g., 4"/>
      </div>
      <div>
        <label for="schemeSelect">Grant scheme</label>
        <select id="schemeSelect"></select>
        <div class="help" id="schemeInfo"></div>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Available for direct costs (live)</label>
      <div class="pill mono" id="availableDirectLine">—</div>
    </div>

    <div id="funderControls" class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="funderModeSelect">Funder indirect cost coverage</label>
        <select id="funderModeSelect">
          <option value="percent_overhead" selected>% of overhead</option>
          <option value="absolute">Fixed amount</option>
          <option value="percent_total">% of total</option>
        </select>
      </div>
      <div id="funderPercentOverBox">
        <label for="funderPercentOverhead">Coverage (% of overhead)</label>
        <input id="funderPercentOverhead" data-decimal="true" placeholder="e.g., 100"/>
      </div>
      <div id="funderAbsoluteBox" class="hidden">
        <label for="funderOverheadAbsolute">Coverage (absolute)</label>
        <input id="funderOverheadAbsolute" data-decimal="false" inputmode="numeric" placeholder="e.g., 150 000"/>
      </div>
      <div id="funderPercentTotalBox" class="hidden">
        <label for="funderOverheadPercent">Coverage (% of total)</label>
        <input id="funderOverheadPercent" data-decimal="true" placeholder="e.g., 25"/>
      </div>
    </div>
  </div>

  <!-- Direct cost allocation -->
  <div class="section">
    <strong>Direct cost allocation</strong>
    <div class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="plannedSalaryDirect">Planned salary costs</label>
        <input id="plannedSalaryDirect" data-decimal="false" inputmode="numeric" placeholder="e.g., 7 000 000"/>
      </div>
      <div>
        <label for="existingSalaries">…of which salary for existing staff</label>
        <input id="existingSalaries" data-decimal="false" inputmode="numeric" placeholder="e.g., 6 000 000"/>
      </div>
      <div>
        <label>Available for other direct costs (live)</label>
        <div class="pill mono" id="availableOtherLine">—</div>
      </div>
    </div>
  </div>

  <!-- Calculate & Results -->
  <div class="section">
    <div class="row" style="justify-content:flex-end;gap:10px">
      <button id="calcBtn">Calculate</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div class="result hidden" id="resultContainer">
      <div id="resultTag" class="tag warn">Result pending…</div>
      <p id="resultExplanation" class="help" style="margin:8px 0 0"></p>

      <div class="bar hidden" id="barContainer">
        <div class="seg s-over" id="overheadBar"></div>
        <div class="seg s-other" id="otherBar"></div>
        <div class="seg s-sal" id="salaryBar"></div>
        <div class="seg s-fac" id="facBar"></div>
        <div class="seg s-cof" id="cofinBar"></div>
      </div>

      <div class="legend hidden" id="legend">
        <span class="legend-item" id="leg-over"><span class="legend-swatch" style="background:var(--gold)"></span>Indirect (funder)</span>
        <span class="legend-item" id="leg-other"><span class="legend-swatch" style="background:var(--green)"></span>Other direct</span>
        <span class="legend-item" id="leg-salary"><span class="legend-swatch" style="background:var(--blue)"></span>Existing salaries</span>
        <span class="legend-item" id="leg-fac"><span class="legend-swatch" style="background:var(--purple)"></span>Univ/Fac contribution</span>
        <span class="legend-item" id="leg-cofin"><span class="legend-swatch" style="background:var(--red)"></span>Dept co-financing</span>
      </div>

      <!-- Summary (always visible after calculation) -->
      <div class="summary-box hidden" id="summaryBox">
        <h3 class="section-title" style="margin-top:0;">Summary</h3>
        <div id="numbersDump"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // [helper functions unchanged except at end]
  const $ = id => document.getElementById(id);
  const fmt = n => (isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:0}).replace(/,/g,' ') : '—');
  const clamp=(x,min,max)=>Math.max(min,Math.min(x,max));
  const num=s=>{if(!s)return 0;const t=String(s);let u=t.replace(/[^\d.,\s-]/g,'').replace(/\s+/g,'');const neg=/^-/.test(u);u=u.replace(/-/g,'');const c=u.lastIndexOf(','),d=u.lastIndexOf('.');let dec=null;if(c>=0||d>=0)dec=(c>d)?',':'.';if(dec){u=u.replace(dec==='.'?/,/g:/\./g,'');const i=u.indexOf(dec);const ip=u.slice(0,i).replace(/[^\d]/g,''),dp=u.slice(i+1).replace(/[^\d]/g,'');return(neg?-1:1)*Number(ip+'.'+dp||'0');}return(neg?-1:1)*Number(u.replace(/[^\d]/g,'')||'0');};
  function formatNumericInput(el){const ad=el.getAttribute('data-decimal')==='true';let v=el.value.replace(/[^\d.,]/g,'');const lc=v.lastIndexOf(','),ld=v.lastIndexOf('.');let ds=null;if(ad&&(lc>=0||ld>=0))ds=(lc>ld)?',':'.';if(ds){v=v.replace(ds==='.'?/,/g:/\./g,'');}else{v=v.replace(/[.,]/g,'');}let i=v,f='';if(ds){const ix=v.indexOf(ds);if(ix>=0){i=v.slice(0,ix);f=v.slice(ix+1).replace(/[^\d]/g,'');}}i=i.replace(/[^\d]/g,'');const fi=i.replace(/\B(?=(\d{3})+(?!\d))/g,' ');el.value=fi+(ad&&ds&&f.length>0?ds+f:'');}
  function attachFormatters(){document.querySelectorAll('input[data-decimal]').forEach(el=>{el.addEventListener('input',()=>{formatNumericInput(el);updateLive();});el.addEventListener('blur',()=>{formatNumericInput(el);updateLive();});});}
  // simpler display part omitted for brevity (same math + bar logic)
  function renderCalcDetails(d){
    const row=(l,v)=>(v>0||v===0)?`<div class='k'>${l}</div><div class='v mono'>${fmt(v)}</div>`:'';
    const text=(l,v)=>`<div class='k'>${l}</div><div class='v'>${v}</div>`;
    return`
    <div class='details-grid cols-2'>
      <div>
        <div class='section-title'>Inputs</div>
        <div class='kv'>
          ${text('Grant scheme',d.scheme)}
          ${row('Amount for Applied IT',d.total)}
          ${text('Project duration',d.years+' year(s)')}
        </div>
        <div class='section-title'>Indirect costs & coverage</div>
        <div class='kv'>
          ${row('Department overhead (cascading)',d.deptOver)}
          ${row('Funder indirect coverage',d.funderCoverage)}
          ${d.ufApplied>0?row('Univ/Faculty contribution',d.ufApplied):''}
        </div>
      </div>
      <div>
        <div class='section-title'>Direct costs</div>
        <div class='kv'>
          ${row('Direct funds available',d.direct)}
          ${row('Planned salary costs',d.plannedSal)}
          ${row('…of which existing staff salaries',d.userSalaries)}
          ${row('Other direct costs',d.other)}
        </div>
        <div class='section-title'>Departmental co-financing needed</div>
        <div class='kv'>${row('Departmental co-financing needed',d.coFinNet)}</div>
      </div>
    </div>`;
  }
  // --- rest identical except at end we show summaryBox
  function calculate(){
    const total=Math.round(num(requestedAmount.value)),years=projectYears.value||'1';
    const {deptOver,fundCov,used,direct}=calcWithDerivedShare(total);
    const coFinRaw=Math.max(0,deptOver-used);
    const ufAgg=sumUfAmount(activeScheme.uf_rules,total,years);
    const facUsed=Math.min(ufAgg.amount,coFinRaw);
    const coFinNet=Math.max(0,coFinRaw-facUsed);
    clampSalaryInputs(direct);
    const ps=Math.max(0,Math.round(num(plannedSalaryDirect.value)));
    const us=Math.max(0,Math.round(num(existingSalaries.value)));
    const other=Math.max(0,direct-ps);
    let cls='warn',txt='UNCLEAR cost-benefit advantage',expl=`Department co-financing cost after Univ/Faculty contribution (${fmt(coFinNet)}) is greater than coverage of existing-salary costs (${fmt(us)}).`;
    if(us>coFinNet){cls='ok';txt='CLEAR cost-benefit advantage';expl=`Coverage of existing-salary costs (${fmt(us)}) exceeds department co-financing cost after Univ/Faculty contribution (${fmt(coFinNet)}).`;}
    else if(us===coFinNet){cls='warn';txt='BREAK-EVEN';expl=`Coverage of existing-salary costs equals department co-financing cost after Univ/Faculty contribution (${fmt(coFinNet)}).`;}
    resultTag.className='tag '+cls;resultTag.textContent=txt;resultExplanation.textContent=expl;resultContainer.classList.remove('hidden');
    // bars (same as before)
    const vals={used,other,us,facUsed,coFinNet},sum=Object.values(vals).reduce((a,b)=>a+b,0);
    if(sum<=0){barContainer.classList.add('hidden');legend.classList.add('hidden');}
    else{barContainer.classList.remove('hidden');legend.classList.remove('hidden');
      const frac=x=>x>0?x/sum:0;
      function seg(b,l,v){if(v>0){b.style.display='flex';b.style.flex=String(frac(v));b.textContent=fmt(v);if(l)l.style.display='inline-flex';}
      else{b.style.display='none';b.textContent='';if(l)l.style.display='none';}}
      seg(bars.overhead,$('leg-over
