<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Research Funding Financial Cost-Benefit Calculator</title>
<style>
  :root{
    --bg:#0b1020; --panel:#11192f; --muted:#9fb0c7; --text:#e6eef7;
    --accent:#7bbfff; --ok:#5bd69f; --warn:#ffd166; --bad:#ff6b6b;
    --gold:#f1c232; --green:#93c47d; --blue:#6fa8dc; --red:#e06666; --purple:#b37bd6;
    --border:rgba(255,255,255,0.14); --panel2:#0d1431;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1020;color:var(--text)}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 14px;font-size:clamp(1.1rem,2.2vw,1.6rem)}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
  .grid{display:grid;gap:14px}
  @media (min-width:820px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  label{display:block;font-weight:600;margin:6px 0}
  input,select{width:100%;background:#0b1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:1rem}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
  .help{font-size:.9rem;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-variant-numeric:tabular-nums}
  button{background:var(--accent);color:#071225;font-weight:700;border:none;border-radius:10px;padding:12px 16px;cursor:pointer;font-size:1rem}
  button.secondary{background:transparent;color:#9fb0c7;border:1px solid var(--border)}
  .result{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:14px}
  .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700}
  .ok{background:rgba(91,214,159,.12);color:var(--ok);border:1px solid rgba(91,214,159,.25)}
  .warn{background:rgba(255,209,102,.12);color:var(--warn);border:1px solid rgba(255,209,102,.25)}
  .bar{display:flex;height:48px;width:100%;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:10px}
  .seg{display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85rem;padding:0 6px;text-shadow:0 1px 2px rgba(0,0,0,.28)}
  .s-over{background:var(--gold)} .s-other{background:var(--green)}
  .s-sal{background:var(--blue)} .s-fac{background:var(--purple)} .s-cof{background:var(--red)}
  .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;margin-bottom:12px}
  .legend-item{display:inline-flex;align-items:center;gap:6px;font-size:.9rem;color:#9fb0c7}
  .legend-swatch{width:14px;height:14px;border-radius:3px;display:inline-block}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1330;border:1px solid var(--border);color:#9fb0c7;font-size:.9rem}
  .hidden{display:none}
  .error{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.35);color:#ff9b9b}

  /* Pedagogical details view */
  .details-grid{display:grid;gap:10px}
  @media (min-width:820px){.details-grid.cols-2{grid-template-columns:1fr 1fr}}
  .kv{display:grid;grid-template-columns:1fr auto;gap:6px 12px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0b1330}
  .kv .k{color:var(--muted)}
  .kv .v{font-weight:700}
  .section-title{margin:12px 0 6px;font-weight:800;color:#cfe2f5}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="pageTitle"></h1>

  <!-- Overhead policy -->
  <div class="section">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>Overhead policy</strong>
      <span id="ohBadge" class="pill hidden"></span>
    </div>
    <div id="configWarn" class="pill error hidden" style="margin-top:8px">Couldn’t load <span class="mono">config.json</span>. Using fallback.</div>
  </div>

  <!-- Amount, years, scheme -->
  <div class="section">
    <div class="grid cols-2">
      <div>
        <label for="requestedAmount">Amount for Applied IT (excl. funding for partners)</label>
        <input id="requestedAmount" data-decimal="false" inputmode="numeric" placeholder="e.g., 10 000 000"/>
      </div>
      <div>
        <label for="projectYears">Project duration (years)</label>
        <input id="projectYears" data-decimal="false" inputmode="numeric" placeholder="e.g., 4"/>
      </div>
      <div>
        <label for="schemeSelect">Grant scheme</label>
        <select id="schemeSelect"></select>
        <div class="help" id="schemeInfo"></div>
      </div>
    </div>

    <!-- Always visible direct costs line -->
    <div style="margin-top:10px">
      <label>Available for direct costs (live)</label>
      <div class="pill mono" id="availableDirectLine">—</div>
    </div>

    <!-- Funder coverage fields (only for Other) -->
    <div id="funderControls" class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="funderModeSelect">Funder indirect cost coverage</label>
        <select id="funderModeSelect">
          <option value="percent_overhead" selected>% of overhead</option>
          <option value="absolute">Fixed amount</option>
          <option value="percent_total">% of total (cascading)</option>
        </select>
      </div>
      <div id="funderPercentOverBox">
        <label for="funderPercentOverhead">Coverage (% of overhead)</label>
        <input id="funderPercentOverhead" data-decimal="true" placeholder="e.g., 100"/>
      </div>
      <div id="funderAbsoluteBox" class="hidden">
        <label for="funderOverheadAbsolute">Coverage (absolute)</label>
        <input id="funderOverheadAbsolute" data-decimal="false" inputmode="numeric" placeholder="e.g., 150 000"/>
      </div>
      <div id="funderPercentTotalBox" class="hidden">
        <label for="funderOverheadPercent">Coverage (% of total, cascading)</label>
        <input id="funderOverheadPercent" data-decimal="true" placeholder="e.g., 25"/>
      </div>
    </div>
  </div>

  <!-- Direct cost allocation -->
  <div class="section">
    <strong>Direct cost allocation</strong>
    <div class="grid cols-2" style="margin-top:10px">
      <div>
        <label for="plannedSalaryDirect">Planned salary costs</label>
        <input id="plannedSalaryDirect" data-decimal="false" inputmode="numeric" placeholder="e.g., 7 000 000"/>
      </div>
      <div>
        <label for="existingSalaries">…of which salary for existing staff</label>
        <input id="existingSalaries" data-decimal="false" inputmode="numeric" placeholder="e.g., 6 000 000"/>
      </div>
      <div>
        <label>Available for other direct costs (live)</label>
        <div class="pill mono" id="availableOtherLine">—</div>
      </div>
    </div>
  </div>

  <!-- Calculate & Results -->
  <div class="section">
    <div class="row" style="justify-content:flex-end;gap:10px">
      <button id="calcBtn">Calculate</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div class="result hidden" id="resultContainer">
      <div id="resultTag" class="tag warn">Result pending…</div>
      <p id="resultExplanation" class="help" style="margin:8px 0 0"></p>

      <div class="bar hidden" id="barContainer">
        <div class="seg s-over"  id="overheadBar"></div>
        <div class="seg s-other" id="otherBar"></div>
        <div class="seg s-sal"   id="salaryBar"></div>
        <div class="seg s-fac"   id="facBar"></div>
        <div class="seg s-cof"   id="cofinBar"></div>
      </div>

      <!-- Legend with IDs so zero-value categories can be hidden -->
      <div class="legend hidden" id="legend">
        <span class="legend-item" id="leg-over"><span class="legend-swatch" style="background:var(--gold)"></span>Indirect (funder)</span>
        <span class="legend-item" id="leg-other"><span class="legend-swatch" style="background:var(--green)"></span>Other direct</span>
        <span class="legend-item" id="leg-salary"><span class="legend-swatch" style="background:var(--blue)"></span>Existing salaries</span>
        <span class="legend-item" id="leg-fac"><span class="legend-swatch" style="background:var(--purple)"></span>Univ/Fac contribution</span>
        <span class="legend-item" id="leg-cofin"><span class="legend-swatch" style="background:var(--red)"></span>Dept co-financing</span>
      </div>

      <details>
        <summary>Calculation details (click to expand)</summary>
        <div id="numbersDump" class="mono" style="margin-top:8px"></div>
      </details>
    </div>
  </div>
</div>

<script>
  // ---------- helpers
  const $ = id => document.getElementById(id);
  const fmt = n => (isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:0}).replace(/,/g,' ') : '—');
  const clamp = (x,min,max)=>Math.max(min,Math.min(x,max));
  const num = s=>{
    if(!s) return 0;
    const t=String(s);
    let u=t.replace(/[^\d.,\s-]/g,'').replace(/\s+/g,'');
    const neg=/^-/.test(u); u=u.replace(/-/g,'');
    const lastComma=u.lastIndexOf(','), lastDot=u.lastIndexOf('.');
    let dec=null;
    if(lastComma>=0 || lastDot>=0) dec=(lastComma>lastDot)?',':'.';
    if(dec){
      u = u.replace(dec==='.'?/,/g:/\./g,'');
      const idx=u.indexOf(dec);
      const ip=u.slice(0,idx).replace(/[^\d]/g,'');
      const dp=u.slice(idx+1).replace(/[^\d]/g,'');
      return (neg?-1:1)*Number(ip+'.'+dp || '0');
    } else {
      return (neg?-1:1)*Number(u.replace(/[^\d]/g,'' )||'0');
    }
  };
  function formatNumericInput(el){
    const allowDecimal = el.getAttribute('data-decimal') === 'true';
    const start = el.selectionStart ?? el.value.length;
    const original = el.value;
    const digitsBeforeCaret = (original.slice(0,start).match(/\d/g)||[]).length;
    let value = original.replace(/[^\d.,]/g,'');
    const lastComma=value.lastIndexOf(','), lastDot=value.lastIndexOf('.');
    let decSep = null;
    if(allowDecimal && (lastComma>=0 || lastDot>=0)) decSep = (lastComma>lastDot)?',':'.';
    if(decSep){ value = value.replace(decSep==='.'?/,/g:/\./g,''); }
    else { value = value.replace(/[.,]/g,''); }
    let intPart = value, fracPart='';
    if(decSep){
      const idx=value.indexOf(decSep);
      if(idx>=0){
        intPart = value.slice(0,idx);
        fracPart = value.slice(idx+1).replace(/[^\d]/g,'');
      }
    }
    intPart = intPart.replace(/[^\d]/g,'');
    const formattedInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g,' ');
    let out = formattedInt;
    if(allowDecimal && decSep && fracPart.length>0){ out += decSep + fracPart; }
    el.value = out;
    const posFromDigitIndex = (str, idx)=>{
      if(idx<=0) return 0;
      let count=0;
      for(let i=0;i<str.length;i++){
        if(/\d/.test(str[i])){ count++; if(count===idx) return i+1; }
      }
      return str.length;
    };
    const newPos = posFromDigitIndex(out, digitsBeforeCaret);
    try{ el.setSelectionRange(newPos,newPos); }catch(e){}
  }
  function attachFormatters(){
    document.querySelectorAll('input[data-decimal]').forEach(el=>{
      el.addEventListener('input', ()=>{ formatNumericInput(el); updateLive(); });
      el.addEventListener('blur',  ()=>{ formatNumericInput(el); updateLive(); });
    });
  }

  // ---------- elements
  const pageTitle=$('pageTitle'), ohBadge=$('ohBadge'), configWarn=$('configWarn');
  const requestedAmount=$('requestedAmount'), projectYears=$('projectYears');
  const schemeSelect=$('schemeSelect'), schemeInfo=$('schemeInfo');

  const funderControls=$('funderControls');
  const funderModeSelect=$('funderModeSelect');
  const funderPercentOverBox=$('funderPercentOverBox');
  const funderAbsoluteBox=$('funderAbsoluteBox');
  const funderPercentTotalBox=$('funderPercentTotalBox');
  const funderPercentOverhead=$('funderPercentOverhead');
  const funderOverheadAbsolute=$('funderOverheadAbsolute');
  const funderOverheadPercent=$('funderOverheadPercent');

  const availableDirectLine=$('availableDirectLine');
  const availableOtherLine=$('availableOtherLine');
  const plannedSalaryDirect=$('plannedSalaryDirect'), existingSalaries=$('existingSalaries');

  const resultContainer=$('resultContainer'), resultTag=$('resultTag'), resultExplanation=$('resultExplanation');
  const barContainer=$('barContainer'), legend=$('legend');
  const bars={overhead:$('overheadBar'), other:$('otherBar'), salary:$('salaryBar'), fac:$('facBar'), cofin:$('cofinBar')};
  const numbersDump=$('numbersDump');

  // ---------- state
  let CONFIG = null;
  let SCHEMES = {}; // id -> { name, funder:{mode,value,label}, uf_rules:[...] }
  let salaryOH=0.62, otherOH=0.52;
  let activeScheme=null;
  let lastShare = 0.5;

  // ---------- UF rules engine
  function computeUfAmount(rule, total, years){
    const yrs = Math.max(1, Math.round(num(years)));
    if(!rule || !rule.mode) return 0;
    if(rule.mode === 'percent_total'){
      const p = Number(rule.value || 0)/100;
      return Math.max(0, Math.round(total * p));
    }
    if(rule.mode === 'fixed_per_year'){
      const a = Number(rule.amount_per_year || 0);
      return Math.max(0, Math.round(a * yrs));
    }
    if(rule.mode === 'percent_total_capped_per_year'){
      const p = Number(rule.value || 0)/100;
      const cap = Number(rule.per_year_cap || 0);
      const raw = total * p;
      const capped = Math.min(raw, cap * yrs);
      return Math.max(0, Math.round(capped));
    }
    return 0;
  }
  function sumUfAmount(rules, total, years){
    if(!Array.isArray(rules) || rules.length===0) return {amount:0, note:''};
    let sum=0, notes=[];
    for(const r of rules){
      const a = computeUfAmount(r, total, years);
      sum += a;
      notes.push(r.notes || r.name || r.mode);
    }
    return {amount: sum, note: notes.join(' + ')};
  }

  // ---------- salary clamping
  function clampSalaryInputs(direct){
    let planned = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    if(planned > direct){ planned = direct; plannedSalaryDirect.value = fmt(planned); }
    let existing = Math.max(0, Math.round(num(existingSalaries.value)));
    if(existing > planned){ existing = planned; existingSalaries.value = fmt(existing); }
  }

  // ---------- core math
  function getFunderCoverage(total, deptOver){
    const mode = activeScheme.funder.mode;
    if(mode==='percent_overhead'){
      const p = activeScheme.funder.value ?? num(funderPercentOverhead.value);
      return Math.round(deptOver * Math.max(0, Math.min(p,100)) / 100);
    }
    if(mode==='percent_total'){
      const p = activeScheme.funder.value ?? num(funderOverheadPercent.value);
      const dec = Math.max(0, Math.min(p,500))/100;
      return Math.round(total * (dec/(1+dec)));
    }
    if(mode==='absolute'){
      const a = activeScheme.funder.value ?? num(funderOverheadAbsolute.value);
      return Math.max(0, Math.min(Math.round(a), total));
    }
    if(mode==='manual'){ // "Other"
      const m = funderModeSelect.value;
      if(m==='percent_overhead'){
        const p = num(funderPercentOverhead.value);
        return Math.round(deptOver * Math.max(0, Math.min(p,100)) / 100);
      }else if(m==='percent_total'){
        const p = num(funderOverheadPercent.value);
        const dec = Math.max(0, Math.min(p,500))/100;
        return Math.round(total * (dec/(1+dec)));
      }else{ // absolute
        const a = num(funderOverheadAbsolute.value);
        return Math.max(0, Math.min(Math.round(a), total));
      }
    }
    return 0; // none
  }
  function calcWithDerivedShare(total){
    let share = lastShare;
    const rs = Math.max(0, Math.min(salaryOH,5));
    const ro = Math.max(0, Math.min(otherOH,5));
    let deptOver=0, fundCov=0, used=0, direct=0;
    for(let i=0;i<3;i++){
      const rEff = rs*share + ro*(1-share);
      deptOver = Math.round(total * (rEff/(1+rEff)));
      fundCov  = getFunderCoverage(total, deptOver);
      used     = Math.min(deptOver, fundCov);
      direct   = Math.max(0, total - used);
      const ps = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
      share    = direct>0 ? Math.max(0, Math.min(ps/direct, 1)) : 0;
    }
    lastShare = share;
    const rEff = rs*share + ro*(1-share);
    return {deptOver, fundCov, used, direct, rEff, share};
  }

  // ---------- UI logic
  function toggleFunderInputs(){
    const isOther = (schemeSelect.value==='other');
    funderControls.classList.toggle('hidden', !isOther);
    const mode = isOther ? funderModeSelect.value : 'percent_overhead';
    funderPercentOverBox.classList.toggle('hidden', !(isOther && mode==='percent_overhead'));
    funderAbsoluteBox.classList.toggle('hidden', !(isOther && mode==='absolute'));
    funderPercentTotalBox.classList.toggle('hidden', !(isOther && mode==='percent_total'));
  }

  // omit "Univ/Faculty: none..." when no uf_rules
  function applyScheme(){
    const id = schemeSelect.value;
    activeScheme = SCHEMES[id];
    if(!activeScheme){ return; }

    if(id==='other'){
      schemeInfo.textContent = '';
      schemeInfo.classList.add('hidden');
    }else{
      const label = activeScheme.funder.label || '—';
      const hasUf = Array.isArray(activeScheme.uf_rules) && activeScheme.uf_rules.length>0;
      const ufText = hasUf
        ? 'Univ/Faculty: ' + activeScheme.uf_rules.map(r=>r.notes || r.name || r.mode).join(' + ')
        : '';
      let text = `Funder: ${label}.`;
      if(hasUf) text += ' ' + ufText;
      schemeInfo.textContent = text;
      schemeInfo.classList.remove('hidden');
    }

    toggleFunderInputs();
    updateLive();
  }

  function updateLive(){
    const total=Math.round(num(requestedAmount.value));
    if(total<=0){
      availableDirectLine.textContent='—';
      availableOtherLine.textContent='—';
      return;
    }
    const {deptOver, fundCov, used, direct} = calcWithDerivedShare(total);
    availableDirectLine.textContent = fmt(direct);
    clampSalaryInputs(direct);
    const planned = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    const otherLive = Math.max(0, direct - planned);
    availableOtherLine.textContent = fmt(otherLive);
  }

  // ---------- Pedagogical renderer for details (updated per your request)
  function renderCalcDetails(d){
    const row = (label, val, suffix='') =>
      (val>0 || val===0 || val==='—')
        ? `<div class="k">${label}</div><div class="v mono">${val==='—' ? '—' : fmt(val)}${suffix}</div>`
        : '';
    const text = (label, val) =>
        `<div class="k">${label}</div><div class="v">${val}</div>`;

    const ufSuffix = d.ufNote ? ` — <span class="help">${d.ufNote}</span>` : '';

    return `
    <div class="details-grid cols-2">

      <div>
        <div class="section-title">Inputs</div>
        <div class="kv">
          ${text('Grant scheme', d.scheme)}
          ${row('Amount for Applied IT', d.total)}
          ${text('Project duration', `${d.years} year(s)`)}
        </div>

        <div class="section-title">Indirect costs & coverage</div>
        <div class="kv">
          ${row('Department overhead (cascading)', d.deptOver)}
          ${row('Funder indirect coverage', d.funderCoverage)}
        </div>
      </div>

      <div>
        <div class="section-title">Direct costs</div>
        <div class="kv">
          ${row('Direct funds available', d.direct)}
          ${row('Planned salary costs', d.plannedSal)}
          ${row('…of which existing staff salaries', d.userSalaries)}
          ${row('Other direct costs', d.other)}
        </div>

        <div class="section-title">Co-financing needed</div>
        <div class="kv">
          ${row('Dept co-financing before Univ/Faculty', d.coFinRaw)}
          ${row('Univ/Faculty contribution (applied)', d.ufApplied, ufSuffix)}
          ${row('Department co-financing cost after Univ/Faculty contribution', d.coFinNet)}
        </div>
      </div>

    </div>
    `;
  }

  // ---------- Calculate & render (zero-value categories hidden in bar; details show zeros)
  function labelAmount(val){ return val>0 ? fmt(val) : ''; }
  function calculate(){
    const total=Math.round(num(requestedAmount.value));
    const years = projectYears.value || '1';
    const {deptOver, fundCov, used, direct} = calcWithDerivedShare(total);
    const coFinRaw = Math.max(0, deptOver - used);
    const ufAgg = sumUfAmount(activeScheme.uf_rules, total, years);
    const facUsed = Math.min(ufAgg.amount, coFinRaw);
    const coFinNet = Math.max(0, coFinRaw - facUsed);
    clampSalaryInputs(direct);
    const plannedSal = Math.max(0, Math.round(num(plannedSalaryDirect.value)));
    const userSalaries = Math.max(0, Math.round(num(existingSalaries.value)));
    const other = Math.max(0, direct - plannedSal);

    // Result tag/explanation (kept above details; nothing inside the Co-financing box)
    let cls='warn', txt='UNCLEAR cost-benefit advantage';
    let expl=`Department co-financing cost after Univ/Faculty contribution (${fmt(coFinNet)}) is greater than coverage of existing-salary costs (${fmt(userSalaries)}).`;
    if(userSalaries>coFinNet){
      cls='ok'; txt='CLEAR cost-benefit advantage';
      expl=`Coverage of existing-salary costs (${fmt(userSalaries)}) exceeds department co-financing cost after Univ/Faculty contribution (${fmt(coFinNet)}).`;
    } else if(userSalaries===coFinNet){
      cls='warn'; txt='BREAK-EVEN';
      expl=`Coverage of existing-salary costs equals department co-financing cost after Univ/Faculty contribution (${fmt(coFinNet)}).`;
    }
    resultTag.className='tag '+cls; resultTag.textContent=txt; resultExplanation.textContent=expl;
    resultContainer.classList.remove('hidden');

    // Build segments & legend visibility (hide zero-value segments)
    const vals = { used, other, userSalaries, facUsed, coFinNet };
    const sum = Object.values(vals).reduce((a,b)=>a+b,0);

    if(sum<=0){
      barContainer.classList.add('hidden');
      legend.classList.add('hidden');
    } else {
      barContainer.classList.remove('hidden');
      legend.classList.remove('hidden');

      const frac = x => x>0 ? x/sum : 0;
      function setSeg(barEl, legEl, val){
        if(val>0){
          barEl.style.display = 'flex';
          barEl.style.flex = String(frac(val));
          barEl.textContent = fmt(val);
          if(legEl) legEl.style.display = 'inline-flex';
        } else {
          barEl.style.display = 'none';
          barEl.textContent = '';
          if(legEl) legEl.style.display = 'none';
        }
      }
      setSeg(bars.overhead, document.getElementById('leg-over'),  vals.used);
      setSeg(bars.other,    document.getElementById('leg-other'), vals.other);
      setSeg(bars.salary,   document.getElementById('leg-salary'),vals.userSalaries);
      setSeg(bars.fac,      document.getElementById('leg-fac'),   vals.facUsed);
      setSeg(bars.cofin,    document.getElementById('leg-cofin'), vals.coFinNet);
    }

    // We still compute modeLabel for internal use, but do not show bracketed notes in details
    const modeLabel = (activeScheme.funder.mode==='percent_overhead') ? '% of overhead'
                     : (activeScheme.funder.mode==='percent_total')    ? '% of total'
                     : (activeScheme.funder.mode==='absolute')         ? 'absolute amount'
                     : (activeScheme.funder.mode==='manual')           ? 'manual'
                     : 'none';

    numbersDump.innerHTML = renderCalcDetails({
      scheme: schemeSelect.options[schemeSelect.selectedIndex].text,
      total,
      years,
      deptOver,
      funderCoverage: getFunderCoverage(total, deptOver),
      // no bracketed notes here:
      funderModeLabel: modeLabel,
      used,
      direct,
      plannedSal,
      userSalaries,
      other,
      coFinRaw,
      ufApplied: facUsed,
      ufNote: ufAgg.note,
      coFinNet
    });
  }

  function resetAll(){
    requestedAmount.value=''; projectYears.value='';
    const defId = (CONFIG?.defaultScheme) || 'vr';
    const defIndex = Array.from(schemeSelect.options).findIndex(o=>o.value===defId);
    schemeSelect.selectedIndex = defIndex>=0 ? defIndex : 0;
    funderModeSelect.value='percent_overhead';
    funderPercentOverhead.value=''; funderOverheadAbsolute.value=''; funderOverheadPercent.value='';
    plannedSalaryDirect.value=''; existingSalaries.value='';
    $('availableDirectLine').textContent='—'; $('availableOtherLine').textContent='—';
    resultContainer.classList.add('hidden'); barContainer.classList.add('hidden'); legend.classList.add('hidden');
    lastShare=0.5;
    applyScheme();
  }

  // ---------- config load + UI build
  async function loadConfig(){
    const cacheBust = `?v=${Date.now()}`; // mitigate GH Pages caching
    try{
      const res = await fetch('config.json'+cacheBust, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      CONFIG = await res.json();
      configWarn.classList.add('hidden');
      const lbl = CONFIG.overhead?.label || '';
      const sal = CONFIG.overhead?.salary_percent ?? 0;
      const oth = CONFIG.overhead?.other_percent ?? 0;
      ohBadge.innerHTML = `${lbl}: <span class="mono">${sal}%</span> on salaries · <span class="mono">${oth}%</span> on other costs`;
      ohBadge.classList.remove('hidden');
    }catch(e){
      // external failed: warn & try embedded fallback
      configWarn.classList.remove('hidden');
      const embedded = document.getElementById('embedded-config');
      if(embedded?.textContent){
        try{ CONFIG = JSON.parse(embedded.textContent); }
        catch{ CONFIG = null; }
      }
      if(!CONFIG){
        CONFIG = {
          title: "Research Funding Financial Cost-Benefit Calculator",
          overhead: { label: "", salary_percent: 62, other_percent: 52 },
          defaultScheme: "vr",
          schemes: [{ id:'other', name:'Other', funder:{mode:'manual', value:null, label:'Manual entry'}, uf_rules:[] }]
        };
      }
      // keep overhead badge hidden when not using external config
      ohBadge.classList.add('hidden');
    }

    // internal OH
    salaryOH = Number(CONFIG.overhead?.salary_percent ?? 62)/100;
    otherOH  = Number(CONFIG.overhead?.other_percent ?? 52)/100;

    // build scheme map
    SCHEMES = {};
    (CONFIG.schemes||[]).forEach(s=>{
      SCHEMES[s.id] = { name:s.name, funder:s.funder||{mode:'none',value:0,label:'—'}, uf_rules:Array.isArray(s.uf_rules)?s.uf_rules:[] };
    });
    if(!SCHEMES['other']) SCHEMES['other'] = { name:'Other', funder:{mode:'manual',value:null,label:'Manual entry'}, uf_rules:[] };

    // page title
    pageTitle.textContent = CONFIG.title || "Research Funding Financial Cost-Benefit Calculator";

    // build select: all except Other, then Other last; default = CONFIG.defaultScheme
    schemeSelect.innerHTML = '';
    (CONFIG.schemes||[]).filter(s=>s.id!=='other').forEach(s=>{
      const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; schemeSelect.appendChild(o);
    });
    const o=document.createElement('option'); o.value='other'; o.textContent='Other'; schemeSelect.appendChild(o);

    const defId = CONFIG.defaultScheme || 'vr';
    const defIndex = Array.from(schemeSelect.options).findIndex(x=>x.value===defId);
    schemeSelect.selectedIndex = defIndex>=0 ? defIndex : 0;

    applyScheme();
    updateLive();
  }

  // events
  function attachLogicListeners(){
    document.querySelectorAll('input[data-decimal]').forEach(el=>{
      el.addEventListener('input', ()=>{ formatNumericInput(el); updateLive(); });
      el.addEventListener('blur',  ()=>{ formatNumericInput(el); updateLive(); });
    });
    funderModeSelect.addEventListener('change', ()=>{toggleFunderInputs(); updateLive();});
    schemeSelect.addEventListener('change', applyScheme);
    $('calcBtn').addEventListener('click', calculate);
    $('resetBtn').addEventListener('click', resetAll);
  }

  // init
  (function init(){
    attachFormatters();
    attachLogicListeners();
    loadConfig();
  })();
</script>

<!-- Optional embedded fallback for local file:// testing; paste your config.json here and remove the {} -->
<script id="embedded-config" type="application/json">
{}
</script>
</body>
</html>
